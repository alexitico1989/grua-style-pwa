{% extends 'grua_app/base.html' %}
{% load static %}

{% block title %}Solicitar Asistencia Mec√°nica - Gr√∫a Style{% endblock %}

{% block extra_css %}
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
    color: #ffffff;
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
}

/* Efectos glassmorphism base */
.glassmorphism {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px;
    padding: 32px;
    margin-bottom: 32px;
    backdrop-filter: blur(10px);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.glassmorphism::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(0, 213, 99, 0.1),
        transparent
    );
    animation: shimmer 6s infinite;
}

.glassmorphism:hover {
    transform: translateY(-2px);
    border-color: rgba(0, 213, 99, 0.3);
    box-shadow: 0 30px 60px rgba(0, 213, 99, 0.15);
}

.glassmorphism h2 {
    color: #00D563;
    margin-bottom: 24px;
    font-size: 1.8rem;
    font-weight: 600;
    text-shadow: 0 0 20px rgba(0, 213, 99, 0.3);
}

/* Animaci√≥n shimmer */
@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

/* Hero Section glassmorphism */
.hero-section {
    background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
    padding: 60px 0;
    position: relative;
    overflow: hidden;
}

.hero-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 30% 50%, rgba(255, 152, 0, 0.1) 0%, transparent 50%);
}

.hero-content {
    text-align: center;
    max-width: 800px;
    margin: 0 auto;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px;
    padding: 40px;
    backdrop-filter: blur(10px);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    position: relative;
    z-index: 2;
}

.hero-title {
    font-size: clamp(2rem, 4vw, 3rem);
    font-weight: 700;
    margin-bottom: 20px;
    line-height: 1.2;
    text-shadow: 0 0 20px rgba(255, 152, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.hero-title i {
    color: #FF9800;
    font-size: 0.9em;
}

.hero-subtitle {
    font-size: 1.125rem;
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.6;
    margin: 0;
}

/* Service Grid glassmorphism */
.service-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
}

.service-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 32px 24px;
    color: #ffffff;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
    min-height: 180px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.service-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 152, 0, 0.2),
        transparent
    );
    animation: shimmer 4s infinite;
}

.service-btn:hover {
    border-color: rgba(255, 152, 0, 0.5);
    background: rgba(255, 152, 0, 0.1);
    transform: translateY(-4px);
    box-shadow: 0 15px 40px rgba(255, 152, 0, 0.2);
}

.service-btn.active {
    background: linear-gradient(135deg, rgba(255, 152, 0, 0.2) 0%, rgba(255, 193, 7, 0.1) 100%);
    border-color: #FF9800;
    box-shadow: 0 0 30px rgba(255, 152, 0, 0.4);
    transform: translateY(-4px);
}

.service-btn input[type="radio"] {
    display: none;
}

.service-icon {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #FF9800, #FF6F00);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
    box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3);
    transition: all 0.3s ease;
}

.service-icon i {
    font-size: 1.5rem;
    color: #000;
}

.service-btn:hover .service-icon,
.service-btn.active .service-icon {
    transform: scale(1.1);
    box-shadow: 0 12px 35px rgba(255, 152, 0, 0.5);
}

.service-btn h3 {
    font-size: 1.25rem;
    margin-bottom: 8px;
    color: #FF9800;
    font-weight: 600;
    text-shadow: 0 0 10px rgba(255, 152, 0, 0.2);
}

.service-btn p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.95rem;
    line-height: 1.4;
    margin: 0;
}

/* Options Grid glassmorphism */
.options-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 24px 0;
}

.option-card {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 24px 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
    min-height: 140px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.option-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 152, 0, 0.15),
        transparent
    );
    animation: shimmer 5s infinite;
}

.option-card:hover {
    border-color: rgba(255, 152, 0, 0.4);
    background: rgba(255, 152, 0, 0.08);
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(255, 152, 0, 0.15);
}

.option-card.selected {
    border-color: #FF9800;
    background: linear-gradient(135deg, rgba(255, 152, 0, 0.2) 0%, rgba(255, 193, 7, 0.1) 100%);
    box-shadow: 0 0 25px rgba(255, 152, 0, 0.3);
    transform: translateY(-3px);
}

.option-card input[type="radio"] {
    display: none;
}

.option-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #FF9800, #FF6F00);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 12px;
    box-shadow: 0 6px 20px rgba(255, 152, 0, 0.3);
    transition: all 0.3s ease;
}

.option-icon i {
    font-size: 1.2rem;
    color: #000;
}

.option-card:hover .option-icon,
.option-card.selected .option-icon {
    transform: scale(1.1);
    box-shadow: 0 8px 25px rgba(255, 152, 0, 0.5);
}

.option-card h4 {
    color: #FF9800;
    margin-bottom: 6px;
    font-size: 1rem;
    font-weight: 600;
    text-shadow: 0 0 8px rgba(255, 152, 0, 0.2);
}

.option-card p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.85rem;
    line-height: 1.3;
    margin: 0;
}

/* Form Elements glassmorphism */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 24px 0;
}

.form-group {
    margin-bottom: 0;
}

.form-group-full {
    grid-column: 1 / -1;
}

.form-group label {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    color: #FF9800;
    font-weight: 600;
    font-size: 0.95rem;
    text-shadow: 0 0 8px rgba(255, 152, 0, 0.2);
    gap: 8px;
}

.form-group label i {
    color: #FF9800;
    font-size: 0.9rem;
    width: 16px;
    text-align: center;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 14px 16px;
    background: rgba(255, 255, 255, 0.08);
    border: 2px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    color: #ffffff;
    font-size: 1rem;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: #FF9800;
    background: rgba(255, 152, 0, 0.1);
    box-shadow: 0 0 20px rgba(255, 152, 0, 0.3);
    transform: translateY(-1px);
}

.form-group input::placeholder,
.form-group textarea::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.form-group input.valid {
    border-color: #FF9800;
    background: rgba(255, 152, 0, 0.08);
    box-shadow: 0 0 15px rgba(255, 152, 0, 0.2);
}

.form-group input.error {
    border-color: #dc3545;
    background: rgba(220, 53, 69, 0.08);
    box-shadow: 0 0 15px rgba(220, 53, 69, 0.2);
}

/* Map Section glassmorphism */
.map-instructions {
    background: rgba(255, 152, 0, 0.08);
    border: 1px solid rgba(255, 152, 0, 0.2);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

.map-instructions::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 152, 0, 0.15),
        transparent
    );
    animation: shimmer 5s infinite;
}

.map-instructions h3 {
    color: #FF9800;
    margin-bottom: 16px;
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    text-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
}

.map-instructions h3 i {
    font-size: 1rem;
}

.map-instructions ul {
    color: rgba(255, 255, 255, 0.9);
    padding-left: 0;
    margin: 0;
    list-style: none;
}

.map-instructions li {
    margin-bottom: 12px;
    font-size: 0.95rem;
    line-height: 1.4;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
}

.map-instructions li:last-child {
    margin-bottom: 0;
}

.map-instructions li i {
    color: #FF9800;
    font-size: 0.9rem;
    width: 16px;
    text-align: center;
    flex-shrink: 0;
}

#map {
    height: 400px;
    width: 100%;
    border-radius: 20px;
    border: 2px solid rgba(255, 152, 0, 0.3);
    position: relative;
    z-index: 0;
    background: #1a1a2e;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}

#map:hover {
    border-color: rgba(255, 152, 0, 0.5);
    box-shadow: 0 15px 40px rgba(255, 152, 0, 0.15);
}

/* Ruta y Precio glassmorphism */
.ruta-seleccionada {
    display: none;
    background: rgba(255, 152, 0, 0.08);
    border: 1px solid rgba(255, 152, 0, 0.2);
    border-radius: 20px;
    padding: 24px;
    margin-top: 24px;
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

.ruta-seleccionada::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 152, 0, 0.15),
        transparent
    );
    animation: shimmer 4s infinite;
}

.ruta-seleccionada h3 {
    color: #FF9800;
    margin-bottom: 20px;
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    text-shadow: 0 0 15px rgba(255, 152, 0, 0.4);
}

.direccion-item {
    background: rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
}

.direccion-item:hover {
    background: rgba(255, 255, 255, 0.12);
    border-color: rgba(255, 152, 0, 0.3);
    transform: translateY(-1px);
}

.direccion-item h4 {
    color: #FF9800;
    margin-bottom: 8px;
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    text-shadow: 0 0 8px rgba(255, 152, 0, 0.2);
}

.direccion-item h4 i {
    font-size: 0.9rem;
    width: 16px;
    text-align: center;
}

.direccion-item p {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.95rem;
    line-height: 1.4;
    margin: 0;
}

.precio-calculado {
    display: none;
    background: linear-gradient(135deg, rgba(255, 152, 0, 0.15) 0%, rgba(255, 193, 7, 0.08) 100%);
    border: 2px solid rgba(255, 152, 0, 0.4);
    border-radius: 20px;
    padding: 24px;
    margin-top: 20px;
    text-align: center;
    box-shadow: 0 0 30px rgba(255, 152, 0, 0.2);
    position: relative;
    overflow: hidden;
}

.precio-calculado::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 152, 0, 0.2),
        transparent
    );
    animation: shimmer 3s infinite;
}

.precio-calculado h3 {
    color: #FF9800;
    font-size: 1.4rem;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    text-shadow: 0 0 15px rgba(255, 152, 0, 0.4);
}

.precio-total {
    font-size: 2.2rem;
    font-weight: 700;
    color: #ffffff;
    text-shadow: 0 0 20px rgba(255, 152, 0, 0.5);
    margin-bottom: 16px;
}

.precio-desglose {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.precio-desglose p {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 8px;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.precio-desglose p:last-child {
    margin-bottom: 0;
}

.precio-desglose p i {
    color: #FF9800;
    font-size: 0.9rem;
    width: 16px;
    text-align: center;
}

.precio-desglose span {
    font-weight: 600;
    color: #FF9800;
}

/* Payment Methods glassmorphism */
.glassmorphism .options-grid .option-card {
    min-height: 160px;
}

/* Pasarela de Pago glassmorphism */
.pasarela-pago {
    margin-top: 32px;
    animation: slideDown 0.4s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.payment-form {
    background: rgba(255, 152, 0, 0.08) !important;
    border: 1px solid rgba(255, 152, 0, 0.2) !important;
}

.payment-form h3 {
    color: #FF9800;
    margin-bottom: 24px;
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    text-shadow: 0 0 15px rgba(255, 152, 0, 0.4);
}

.security-notice {
    margin-top: 20px;
    padding: 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    gap: 12px;
}

.security-notice i {
    color: #FF9800;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.security-notice p {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
    margin: 0;
    line-height: 1.4;
}

/* Fecha programada glassmorphism */
.fecha-programada {
    display: none;
    margin-top: 24px;
    background: rgba(255, 152, 0, 0.08);
    border: 1px solid rgba(255, 152, 0, 0.2);
    border-radius: 16px;
    padding: 20px;
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

.fecha-programada::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 152, 0, 0.15),
        transparent
    );
    animation: shimmer 5s infinite;
}

.fecha-programada label {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    color: #FF9800;
    font-weight: 600;
    gap: 8px;
    text-shadow: 0 0 8px rgba(255, 152, 0, 0.2);
}

.fecha-programada input[type="datetime-local"] {
    width: 100%;
    padding: 14px 16px;
    background: rgba(255, 255, 255, 0.08);
    border: 2px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    color: #ffffff;
    font-size: 1rem;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.fecha-programada input[type="datetime-local"]:focus {
    outline: none;
    border-color: #FF9800;
    background: rgba(255, 152, 0, 0.1);
    box-shadow: 0 0 20px rgba(255, 152, 0, 0.3);
    transform: translateY(-1px);
}

/* Submit Button glassmorphism */
button#btn-enviar.submit-btn {
    background: linear-gradient(135deg, #FF9800 0%, #FFB74D 100%) !important;
    border: none !important;
    border-radius: 16px !important;
    padding: 18px 32px !important;
    color: #ffffff !important;
    font-size: 1.1rem !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    width: 100% !important;
    margin-top: 32px !important;
    text-transform: uppercase !important;
    letter-spacing: 1px !important;
    box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3) !important;
    position: relative !important;
    overflow: hidden !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 12px !important;
    backdrop-filter: blur(10px) !important;
    min-height: auto !important;
}

button#btn-enviar.submit-btn::before {
    content: '' !important;
    position: absolute !important;
    top: 0 !important;
    left: -100% !important;
    width: 100% !important;
    height: 100% !important;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent) !important;
    animation: shimmer 3s infinite !important;
}

button#btn-enviar.submit-btn:hover {
    transform: translateY(-4px) !important;
    box-shadow: 0 15px 40px rgba(255, 152, 0, 0.4) !important;
    background: linear-gradient(135deg, #FF8F00 0%, #FF9800 100%) !important;
}

button#btn-enviar.submit-btn:disabled {
    background: rgba(255, 255, 255, 0.1) !important;
    color: rgba(255, 255, 255, 0.5) !important;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .container {
        padding: 16px;
    }
    
    .glassmorphism {
        padding: 24px 20px;
        margin-bottom: 24px;
    }
    
    .hero-content {
        padding: 32px 24px;
    }
    
    .service-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .options-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    #map {
        height: 300px;
    }
    
    .precio-total {
        font-size: 1.8rem;
    }
}

@media (max-width: 480px) {
    .options-grid {
        grid-template-columns: 1fr;
    }
    
    .glassmorphism h2 {
        font-size: 1.5rem;
    }
    
    .hero-title {
        font-size: 2rem;
    }
}
</style>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title">
                <i class="fas fa-tools"></i>
                Solicitar Asistencia Mec√°nica
            </h1>
            <p class="hero-subtitle">
                Servicio de asistencia mec√°nica las 24 horas del d√≠a, los 7 d√≠as de la semana
            </p>
        </div>
    </div>
</section>

<div class="container">
    <!-- Tipo de Servicio -->
    <section class="glassmorphism">
        <h2>Tipo de Servicio</h2>
        <div class="service-grid">
            <div class="service-btn" onclick="selectService('inmediato')">
                <input type="radio" name="tipo_servicio" value="inmediato" id="servicio_inmediato">
                <div class="service-icon">
                    <i class="fas fa-bolt"></i>
            </div>
            <h3>Servicio Inmediato</h3>
            <p>Atenci√≥n en el menor tiempo posible</p>
        </div>
        <div class="service-btn" onclick="selectService('programado')">
            <input type="radio" name="tipo_servicio" value="programado" id="servicio_programado">
            <div class="service-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <h3>Servicio Programado</h3>
            <p>Programa tu servicio para una fecha espec√≠fica</p>
        </div>
    </div>
        
    <div id="fecha-programada" class="fecha-programada">
        <label for="fecha_hora">Fecha y Hora del Servicio:</label>
        <input type="datetime-local" id="fecha_hora" name="fecha_hora">
    </div>
</section>

<!-- Tipo de Problema -->
<section class="glassmorphism">
    <h2>Tipo de Problema</h2>
    <div class="options-grid">
        <div class="option-card" onclick="selectOption('problema', 'bateria')">
            <input type="radio" name="tipo_problema" value="bateria" id="problema_bateria">
            <div class="option-icon">
                <i class="fas fa-car-battery"></i>
            </div>
            <h4>Bater√≠a Descargada</h4>
            <p>Arranque con cables</p>
        </div>
        <div class="option-card" onclick="selectOption('problema', 'llaves')">
            <input type="radio" name="tipo_problema" value="llaves" id="problema_llaves">
            <div class="option-icon">
                <i class="fas fa-key"></i>
            </div>
            <h4>Llaves Adentro</h4>
            <p>Apertura de veh√≠culo</p>
        </div>
        <div class="option-card" onclick="selectOption('problema', 'combustible')">
            <input type="radio" name="tipo_problema" value="combustible" id="problema_combustible">
            <div class="option-icon">
                <i class="fas fa-gas-pump"></i>
            </div>
            <h4>Sin Combustible</h4>
            <p>Suministro de combustible</p>
        </div>
        <div class="option-card" onclick="selectOption('problema', 'neumatico')">
            <input type="radio" name="tipo_problema" value="neumatico" id="problema_neumatico">
            <div class="option-icon">
                <i class="fas fa-life-ring"></i>
            </div>
            <h4>Neum√°tico Pinchado</h4>
            <p>Cambio de neum√°tico</p>
        </div>
        <div class="option-card" onclick="selectOption('problema', 'motor')">
            <input type="radio" name="tipo_problema" value="motor" id="problema_motor">
            <div class="option-icon">
                <i class="fas fa-key"></i>
            </div>
            <h4>No Enciende</h4>
            <p>Diagn√≥stico del motor</p>
        </div>
        <div class="option-card" onclick="selectOption('problema', 'sobrecalentamiento')">
            <input type="radio" name="tipo_problema" value="sobrecalentamiento" id="problema_sobrecalentamiento">
            <div class="option-icon">
                <i class="fas fa-thermometer-three-quarters"></i>
            </div>
            <h4>Sobrecalentamiento</h4>
            <p>Revisi√≥n del radiador</p>
        </div>
        <div class="option-card" onclick="selectOption('problema', 'electrico')">
            <input type="radio" name="tipo_problema" value="electrico" id="problema_electrico">
            <div class="option-icon">
                <i class="fas fa-bolt"></i>
            </div>
            <h4>Problema El√©ctrico</h4>
            <p>Diagn√≥stico el√©ctrico</p>
        </div>
        <div class="option-card" onclick="selectOption('problema', 'otro')">
            <input type="radio" name="tipo_problema" value="otro" id="problema_otro">
            <div class="option-icon">
                <i class="fas fa-tools"></i>
            </div>
            <h4>Otro Problema</h4>
            <p>Describe tu problema</p>
        </div>
    </div>
</section>

<!-- Selecci√≥n de Veh√≠culo -->
<section class="glassmorphism">
    <h2>Tipo de Veh√≠culo</h2>
    <div class="options-grid">
        <div class="option-card" onclick="selectOption('vehiculo', 'auto')">
            <input type="radio" name="tipo_vehiculo" value="auto" id="vehiculo_auto">
            <div class="option-icon">
                <i class="fas fa-car"></i>
            </div>
            <h4>Auto</h4>
            <p>Veh√≠culos livianos</p>
        </div>
        <div class="option-card" onclick="selectOption('vehiculo', 'camioneta')">
            <input type="radio" name="tipo_vehiculo" value="camioneta" id="vehiculo_camioneta">
            <div class="option-icon">
                <i class="fas fa-truck-pickup"></i>
            </div>
            <h4>Camioneta</h4>
            <p>Pick-up y SUV</p>
        </div>
        <div class="option-card" onclick="selectOption('vehiculo', 'moto')">
            <input type="radio" name="tipo_vehiculo" value="moto" id="vehiculo_moto">
            <div class="option-icon">
                <i class="fas fa-motorcycle"></i>
            </div>
            <h4>Motocicleta</h4>
            <p>Motos y scooters</p>
        </div>
        <div class="option-card" onclick="selectOption('vehiculo', 'camion')">
            <input type="radio" name="tipo_vehiculo" value="camion" id="vehiculo_camion">
            <div class="option-icon">
                <i class="fas fa-truck"></i>
            </div>
            <h4>Cami√≥n</h4>
            <p>Veh√≠culos pesados</p>
        </div>
    </div>
</section>

<!-- Ubicaci√≥n del Servicio -->
<section class="glassmorphism">
    <h2>
        <i class="fas fa-map-marked-alt" style="margin-right: 10px; font-size: 0.9em;"></i>
        Ubicaci√≥n del Servicio
    </h2>
    
    <div class="map-instructions">
        <h3>
            <i class="fas fa-info-circle"></i>
            Instrucciones:
        </h3>
        <ul>
            <li>
                <i class="fas fa-mouse-pointer"></i>
                Haz clic en el mapa para seleccionar donde est√° tu veh√≠culo
            </li>
            <li>
                <i class="fas fa-tools"></i>
                El t√©cnico se dirigir√° directamente a esa ubicaci√≥n
            </li>
            <li>
                <i class="fas fa-arrows-alt"></i>
                Puedes arrastrar el marcador para ajustar la ubicaci√≥n
            </li>
        </ul>
    </div>
    
    <div id="map"></div>
        
    <div id="ruta-seleccionada" class="ruta-seleccionada">
        <h3>
            <i class="fas fa-map-marker-alt"></i>
            Ubicaci√≥n Seleccionada
        </h3>
        <div id="direccion-origen" class="direccion-item">
            <h4>
                <i class="fas fa-tools"></i>
                Ubicaci√≥n del Servicio:
            </h4>
            <p id="texto-origen">Selecciona un punto en el mapa</p>
        </div>
        <div id="precio-calculado" class="precio-calculado">
            <h3>
                <i class="fas fa-calculator"></i>
                Precio del Servicio
            </h3>
            <div class="precio-total" id="precio-total">$30.000</div>
            <div class="precio-desglose">
                <p><i class="fas fa-tools"></i> Tarifa base de asistencia: <span id="precio-base">$30.000</span></p>
                <p><i class="fas fa-info-circle"></i> Precio fijo por servicio en el lugar</p>
            </div>
        </div>
    </div>
</section>

<!-- M√©todo de Pago -->
<section class="glassmorphism">
    <h2>
        <i class="fas fa-credit-card" style="margin-right: 10px; font-size: 0.9em;"></i>
        M√©todo de Pago
    </h2>
    <div class="options-grid">
        <div class="option-card" onclick="selectOption('pago', 'efectivo')">
            <input type="radio" name="metodo_pago" value="efectivo" id="pago_efectivo">
            <div class="option-icon">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <h4>Efectivo</h4>
            <p>Pago en efectivo</p>
        </div>
        <div class="option-card" onclick="selectOption('pago', 'mercadopago_card')">
            <input type="radio" name="metodo_pago" value="mercadopago_card" id="pago_mercadopago_card">
            <div class="option-icon">
                <i class="fas fa-credit-card"></i>
            </div>
            <h4>Tarjeta</h4>
            <p>Pago con tarjeta</p>
        </div>
        <div class="option-card" onclick="selectOption('pago', 'transferencia')">
            <input type="radio" name="metodo_pago" value="transferencia" id="pago_transferencia">
            <div class="option-icon">
                <i class="fas fa-university"></i>
            </div>
            <h4>Transferencia</h4>
            <p>Transferencia bancaria</p>
        </div>
    </div>
        
    <!-- Secci√≥n de pasarela de pago (oculta por defecto) -->
    <div id="pasarela-pago" class="pasarela-pago" style="display: none;">
        <div class="glassmorphism payment-form">
            <h3>
                <i class="fas fa-credit-card"></i>
                Informaci√≥n de Tarjeta
            </h3>
            
            <div class="form-grid">
                <div class="form-group form-group-full">
                    <label for="numero_tarjeta">
                        <i class="fas fa-credit-card"></i>
                        N√∫mero de Tarjeta
                    </label>
                    <input type="text" id="numero_tarjeta" name="numero_tarjeta" placeholder="1234 5678 9012 3456" maxlength="19">
                </div>
                
                <div class="form-group">
                    <label for="fecha_vencimiento">
                        <i class="fas fa-calendar-alt"></i>
                        Vencimiento
                    </label>
                    <input type="text" id="fecha_vencimiento" name="fecha_vencimiento" placeholder="MM/AA" maxlength="5">
                </div>
                
                <div class="form-group">
                    <label for="cvv">
                        <i class="fas fa-lock"></i>
                        CVV
                    </label>
                    <input type="text" id="cvv" name="cvv" placeholder="123" maxlength="4">
                </div>
                
                <div class="form-group form-group-full">
                    <label for="nombre_titular">
                        <i class="fas fa-user"></i>
                        Nombre del Titular
                    </label>
                    <input type="text" id="nombre_titular" name="nombre_titular" placeholder="Nombre como aparece en la tarjeta">
                </div>
            </div>
            
            <div class="security-notice">
                <i class="fas fa-shield-alt"></i>
                <p>Tu informaci√≥n est√° segura. Utilizamos encriptaci√≥n SSL para proteger tus datos.</p>
            </div>
        </div>
    </div>
</section>

<!-- Datos del Cliente -->
<section class="glassmorphism">
    <h2>
        <i class="fas fa-user" style="margin-right: 10px; font-size: 0.9em;"></i>
        Datos del Cliente
    </h2>
    <form id="formulario-servicio" method="post">
        {% csrf_token %}

        <!-- Informaci√≥n del Veh√≠culo -->
        <section class="glassmorphism">
            <h2>
                <i class="fas fa-info-circle" style="margin-right: 10px; font-size: 0.9em;"></i>
                Informaci√≥n del Veh√≠culo
            </h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="marca_vehiculo">
                        <i class="fas fa-industry"></i>
                        Marca del Veh√≠culo *
                    </label>
                    <input type="text" id="marca_vehiculo" name="marca_vehiculo" placeholder="Ej: Toyota, Chevrolet, Ford" required>
                </div>
                
                <div class="form-group">
                    <label for="modelo_vehiculo">
                        <i class="fas fa-car-side"></i>
                        Modelo del Veh√≠culo *
                    </label>
                    <input type="text" id="modelo_vehiculo" name="modelo_vehiculo" placeholder="Ej: Corolla, Aveo, Fiesta" required>
                </div>
                
                <div class="form-group form-group-full">
                    <label for="patente_vehiculo">
                        <i class="fas fa-id-card"></i>
                        Patente del Veh√≠culo *
                    </label>
                    <input type="text" id="patente_vehiculo" name="placa_vehiculo" placeholder="Ej: ABCD12, AB1234" maxlength="6" style="text-transform: uppercase;" required>
                </div>
            </div>
        </section>
        
        <div class="form-grid">
            <div class="form-group">
                <label for="nombre">
                    <i class="fas fa-user"></i>
                    Nombre Completo *
                </label>
                <input type="text" id="nombre" name="nombre" required>
            </div>
            
            <div class="form-group">
                <label for="telefono">
                    <i class="fas fa-phone"></i>
                    Tel√©fono *
                </label>
                <input type="tel" id="telefono" name="telefono" required>
            </div>
        </div>
        
        <div class="form-group">
            <label for="email">
                <i class="fas fa-envelope"></i>
                Email
            </label>
            <input type="email" id="email" name="email">
        </div>
        
        <div class="form-group">
            <label for="comentarios">
                <i class="fas fa-comment-alt"></i>
                Describe el Problema en Detalle
            </label>
            <textarea id="comentarios" name="descripcion_problema" rows="4" placeholder="Describe exactamente qu√© problema tienes con tu veh√≠culo para que el t√©cnico venga preparado..."></textarea>
        </div>
            
        <!-- Campos ocultos para los datos del servicio -->
        <input type="hidden" id="hidden_tipo_servicio" name="tipo_servicio">
        <input type="hidden" id="hidden_fecha_hora" name="fecha_servicio">
        <input type="hidden" id="hidden_tipo_problema" name="tipo_problema">
        <input type="hidden" id="hidden_tipo_vehiculo" name="tipo_vehiculo">
        <input type="hidden" id="hidden_metodo_pago" name="metodo_pago">
        <input type="hidden" id="hidden_origen_lat" name="origen_lat">
        <input type="hidden" id="hidden_origen_lng" name="origen_lng">
        <input type="hidden" id="hidden_destino_lat" name="destino_lat" value="0">
        <input type="hidden" id="hidden_destino_lng" name="destino_lng" value="0">
        <input type="hidden" id="hidden_origen_direccion" name="direccion_origen">
        <input type="hidden" id="hidden_destino_direccion" name="direccion_destino" value="Servicio en el lugar">
        <input type="hidden" id="hidden_distancia" name="distancia_km" value="0">
        <input type="hidden" id="hidden_precio_total" name="costo_total" value="30000">
        <input type="hidden" id="hidden_tipo_servicio_categoria" name="tipo_servicio_categoria" value="asistencia">

        
        <button type="submit" id="btn-enviar" class="submit-btn" disabled>
            Solicitar Asistencia Mec√°nica
        </button>
    </form>
</section>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
console.log('üîß Iniciando aplicaci√≥n de asistencia mec√°nica...');

// Variables globales
let map;
let ubicacionMarker = null;
let clickCount = 0;

// Precios para asistencia mec√°nica
const PRECIO_BASE_ASISTENCIA = 30000;

// Inicializaci√≥n cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM cargado, iniciando mapa...');
    initMap();
    setupEventListeners();
    // Mostrar precio fijo desde el inicio
    mostrarPrecioFijo();
});

// Inicializar el mapa
function initMap() {
    try {
        console.log('üó∫Ô∏è Verificando disponibilidad de Leaflet...');
        if (typeof L === 'undefined') {
            console.error('‚ùå Leaflet no est√° disponible');
            return;
        }
        console.log('‚úÖ Leaflet disponible, creando mapa...');
        
        // Crear el mapa centrado en Santiago, Chile
        map = L.map('map').setView([-33.4489, -70.6693], 12);
        console.log('‚úÖ Mapa creado, agregando tiles...');
        
        // Agregar tiles de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        console.log('‚úÖ Tiles agregados');
        
        // Event listener para clicks en el mapa
        map.on('click', onMapClick);
        console.log('‚úÖ Event listener agregado');
        
        console.log('‚úÖ Mapa completamente inicializado');
        
    } catch (error) {
        console.error('‚ùå Error inicializando mapa:', error);
    }
}

// Manejar clicks en el mapa (solo un punto para asistencia)
function onMapClick(e) {
    console.log('üñ±Ô∏è Click en mapa:', e.latlng);
    
    // Remover marcador anterior si existe
    if (ubicacionMarker) {
        map.removeLayer(ubicacionMarker);
    }
    
    // Crear marcador de ubicaci√≥n
    ubicacionMarker = L.marker(e.latlng, {
        draggable: true,
        icon: L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        })
    }).addTo(map);
    
    ubicacionMarker.bindPopup('üîß Ubicaci√≥n del servicio').openPopup();
    
    // Event listener para el drag del marcador
    ubicacionMarker.on('dragend', function() {
        console.log('üîß Ubicaci√≥n movida:', ubicacionMarker.getLatLng());
        reverseGeocode(ubicacionMarker.getLatLng(), 'origen');
    });
    
    // Obtener direcci√≥n de la ubicaci√≥n
    reverseGeocode(e.latlng, 'origen');
    
    // Mostrar secci√≥n de ubicaci√≥n seleccionada
    document.getElementById('ruta-seleccionada').style.display = 'block';
    document.getElementById('precio-calculado').style.display = 'block';
}

function reverseGeocode(latlng, tipo) {
    console.log(`üìç Obteniendo direcci√≥n para ${tipo}:`, latlng);
    
    // Usar Nominatim para obtener direcci√≥n
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&zoom=18&addressdetails=1`;
    
    fetch(url)
    .then(response => response.json())
    .then(data => {
        if (data && data.display_name) {
            let direccion = data.display_name;
            
            // Simplificar direcci√≥n para Chile
            if (data.address) {
                const addr = data.address;
                let direccionSimple = '';
                
                if (addr.house_number && addr.road) {
                    direccionSimple = `${addr.road} ${addr.house_number}`;
                } else if (addr.road) {
                    direccionSimple = addr.road;
                }
                
                if (addr.suburb || addr.neighbourhood) {
                    direccionSimple += `, ${addr.suburb || addr.neighbourhood}`;
                }
                
                if (addr.city || addr.town) {
                    direccionSimple += `, ${addr.city || addr.town}`;
                }
                
                direccion = direccionSimple || data.display_name;
            }
            
            console.log(`‚úÖ Direcci√≥n ${tipo}:`, direccion);
            
            if (tipo === 'origen') {
                document.getElementById('texto-origen').textContent = direccion;
                document.getElementById('hidden_origen_lat').value = latlng.lat;
                document.getElementById('hidden_origen_lng').value = latlng.lng;
                document.getElementById('hidden_origen_direccion').value = direccion;
            }
            
            validateForm();
        } else {
            document.getElementById(`texto-${tipo}`).textContent = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
        }
    })
    .catch(error => {
        console.error(`‚ùå Error obteniendo direcci√≥n para ${tipo}:`, error);
        document.getElementById(`texto-${tipo}`).textContent = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
    });
}

// Mostrar precio fijo
function mostrarPrecioFijo() {
    document.getElementById('precio-total').textContent = `${PRECIO_BASE_ASISTENCIA.toLocaleString('es-CL')}`;
    document.getElementById('precio-base').textContent = `${PRECIO_BASE_ASISTENCIA.toLocaleString('es-CL')}`;
    document.getElementById('hidden_precio_total').value = PRECIO_BASE_ASISTENCIA;
}

// Configurar event listeners
function setupEventListeners() {
    console.log('üéß Configurando event listeners...');
    
    // Formulario
    document.getElementById('formulario-servicio').addEventListener('submit', handleFormSubmit);
    
    // Campos del formulario para validaci√≥n en tiempo real
    document.getElementById('nombre').addEventListener('input', validateForm);
    document.getElementById('telefono').addEventListener('input', validateForm);
    document.getElementById('email').addEventListener('input', validateForm);
    document.getElementById('marca_vehiculo').addEventListener('input', validateForm);
    document.getElementById('modelo_vehiculo').addEventListener('input', validateForm);
    document.getElementById('patente_vehiculo').addEventListener('input', validateForm);
    document.getElementById('comentarios').addEventListener('input', validateForm);
    document.getElementById('fecha_hora').addEventListener('change', function() {
        document.getElementById('hidden_fecha_hora').value = this.value;
        validateForm();
    });
    
    // Validaci√≥n de patente chilena
    document.getElementById('patente_vehiculo').addEventListener('input', function(e) {
        let value = e.target.value.toUpperCase();
        value = value.replace(/[^A-Z0-9]/g, '');
        if (value.length > 6) value = value.substring(0, 6);
        e.target.value = value;
        validateForm();
    });
    
    setupCreditCardListeners();
}

// Configurar validaciones para campos de tarjeta
function setupCreditCardListeners() {
    console.log('üí≥ Configurando validaciones de tarjeta...');
    
    // Formatear n√∫mero de tarjeta
    document.getElementById('numero_tarjeta').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
        e.target.value = value;
        validateForm();
    });
    
    // Formatear fecha de vencimiento
    document.getElementById('fecha_vencimiento').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
        validateForm();
    });
    
    // Validar CVV
    document.getElementById('cvv').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        e.target.value = value;
        validateForm();
    });
    
    document.getElementById('nombre_titular').addEventListener('input', validateForm);
}

// Seleccionar tipo de servicio
function selectService(tipo) {
    console.log('üîß Seleccionando servicio:', tipo);
    
    document.querySelectorAll('.service-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    event.currentTarget.classList.add('active');
    document.getElementById(`servicio_${tipo}`).checked = true;
    document.getElementById('hidden_tipo_servicio').value = tipo;
    
    const fechaProgramada = document.getElementById('fecha-programada');
    if (tipo === 'programado') {
        fechaProgramada.style.display = 'block';
        document.getElementById('fecha_hora').required = true;
    } else {
        fechaProgramada.style.display = 'none';
        document.getElementById('fecha_hora').required = false;
        document.getElementById('fecha_hora').value = '';
        
        const ahora = new Date();
        const fechaActual = ahora.toISOString().slice(0, 16);
        document.getElementById('hidden_fecha_hora').value = fechaActual;
    }
    
    validateForm();
}

// Seleccionar opci√≥n (problema, veh√≠culo o pago)
function selectOption(categoria, valor) {
    console.log(`üîß Seleccionando ${categoria}:`, valor);
    
    if (categoria === 'problema') {
        document.querySelectorAll('.option-card').forEach(card => {
            const input = card.querySelector('input[name="tipo_problema"]');
            if (input) card.classList.remove('selected');
        });
        
        document.getElementById(`problema_${valor}`).checked = true;
        document.getElementById('hidden_tipo_problema').value = valor;
        event.currentTarget.classList.add('selected');
        
    } else if (categoria === 'vehiculo') {
        document.querySelectorAll('.option-card').forEach(card => {
            const input = card.querySelector('input[name="tipo_vehiculo"]');
            if (input) card.classList.remove('selected');
        });
        
        document.getElementById(`vehiculo_${valor}`).checked = true;
        document.getElementById('hidden_tipo_vehiculo').value = valor;
        event.currentTarget.classList.add('selected');
        
    } else if (categoria === 'pago') {
        document.querySelectorAll('.option-card').forEach(card => {
            const input = card.querySelector('input[name="metodo_pago"]');
            if (input) card.classList.remove('selected');
        });
        
        if (valor === 'mercadopago_card') {
            document.getElementById('pago_mercadopago_card').checked = true;
            document.getElementById('pasarela-pago').style.display = 'block';
        } else {
            document.getElementById(`pago_${valor}`).checked = true;
            document.getElementById('pasarela-pago').style.display = 'none';
        }
        document.getElementById('hidden_metodo_pago').value = valor;
        event.currentTarget.classList.add('selected');
    }
    
    validateForm();
}

// Validar formulario
function validateForm() {
    console.log('üîß Validando formulario de asistencia...');
    
    const tipoServicio = document.getElementById('hidden_tipo_servicio').value;
    const tipoProblema = document.getElementById('hidden_tipo_problema').value;
    const tipoVehiculo = document.getElementById('hidden_tipo_vehiculo').value;
    const metodoPago = document.getElementById('hidden_metodo_pago').value;
    const nombre = document.getElementById('nombre').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    const email = document.getElementById('email').value.trim();
    const marcaVehiculo = document.getElementById('marca_vehiculo').value.trim();
    const modeloVehiculo = document.getElementById('modelo_vehiculo').value.trim();
    const patenteVehiculo = document.getElementById('patente_vehiculo').value.trim();
    const descripcionProblema = document.getElementById('comentarios').value.trim();
    const origenLat = document.getElementById('hidden_origen_lat').value;
    
    // Debug de valores actuales
    console.log('üìã Valores actuales:', {
        tipoServicio,
        tipoProblema,
        tipoVehiculo,
        metodoPago,
        nombre,
        telefono,
        email,
        marcaVehiculo,
        modeloVehiculo,
        patenteVehiculo,
        descripcionProblema: descripcionProblema.length,
        origenLat
    });
    
    // Validaciones espec√≠ficas (m√°s flexibles)
    const nombreValido = nombre.length >= 2;
    const telefonoValido = telefono.length >= 8;
    const emailValido = !email || isValidEmail(email);
    const marcaValida = marcaVehiculo.length >= 2;
    const modeloValido = modeloVehiculo.length >= 2;
    const patenteValida = patenteVehiculo.length >= 5;
    const descripcionValida = descripcionProblema.length >= 5; // Reducido de 10 a 5
    
    // Validar campos de tarjeta si es necesario
    let tarjetaValida = true;
    if (metodoPago === 'mercadopago_card') {
        const numeroTarjeta = document.getElementById('numero_tarjeta').value.replace(/\s/g, '');
        const fechaVencimiento = document.getElementById('fecha_vencimiento').value;
        const cvv = document.getElementById('cvv').value;
        const nombreTitular = document.getElementById('nombre_titular').value.trim();
        
        tarjetaValida = numeroTarjeta.length >= 13 && 
                       fechaVencimiento.length === 5 && 
                       cvv.length >= 3 && 
                       nombreTitular.length >= 3;
        
        console.log('üí≥ Validaci√≥n tarjeta:', {
            numeroTarjeta: numeroTarjeta.length,
            fechaVencimiento: fechaVencimiento.length,
            cvv: cvv.length,
            nombreTitular: nombreTitular.length,
            tarjetaValida
        });
    }
    
    let fechaValida = true;
    if (tipoServicio === 'programado') {
        const fechaHora = document.getElementById('fecha_hora').value;
        fechaValida = !!fechaHora;
        
        if (fechaHora) {
            const fechaSeleccionada = new Date(fechaHora);
            const ahora = new Date();
            fechaValida = fechaSeleccionada > ahora;
        }
        
        document.getElementById('hidden_fecha_hora').value = fechaHora || '';
    } else {
        // Para servicio inmediato, establecer fecha actual
        const ahora = new Date();
        const fechaActual = ahora.toISOString().slice(0, 16);
        document.getElementById('hidden_fecha_hora').value = fechaActual;
    }
    
    // Validar ubicaci√≥n (m√°s flexible)
    const ubicacionValida = origenLat && parseFloat(origenLat) !== 0;
    
    const formValido = tipoServicio && 
                      tipoProblema &&
                      tipoVehiculo && 
                      metodoPago && 
                      nombreValido && 
                      telefonoValido && 
                      emailValido &&
                      marcaValida &&
                      modeloValido &&
                      patenteValida &&
                      descripcionValida &&
                      ubicacionValida && 
                      fechaValida &&
                      tarjetaValida;
    
    const btnEnviar = document.getElementById('btn-enviar');
    if (btnEnviar) {
        btnEnviar.disabled = !formValido;
        
        // Actualizar texto del bot√≥n seg√∫n m√©todo de pago
        if (formValido) {
            switch (metodoPago) {
                case 'efectivo':
                    btnEnviar.innerHTML = 'üíµ Solicitar Asistencia - Pago en Efectivo';
                    break;
                case 'transferencia':
                    btnEnviar.innerHTML = 'üè¶ Solicitar Asistencia - Pago por Transferencia';
                    break;
                case 'mercadopago_card':
                    btnEnviar.innerHTML = 'üí≥ Solicitar Asistencia - Pago con Tarjeta';
                    break;
                default:
                    btnEnviar.innerHTML = 'üîß Solicitar Asistencia Mec√°nica';
            }
        } else {
            btnEnviar.innerHTML = 'üîß Solicitar Asistencia Mec√°nica';
        }
    }
    
    console.log('üìã Estado detallado del formulario:', {
        tipoServicio: { valor: tipoServicio, valido: !!tipoServicio },
        tipoProblema: { valor: tipoProblema, valido: !!tipoProblema },
        tipoVehiculo: { valor: tipoVehiculo, valido: !!tipoVehiculo },
        metodoPago: { valor: metodoPago, valido: !!metodoPago },
        nombre: { valor: nombre, valido: nombreValido },
        telefono: { valor: telefono, valido: telefonoValido },
        email: { valor: email, valido: emailValido },
        marca: { valor: marcaVehiculo, valido: marcaValida },
        modelo: { valor: modeloVehiculo, valido: modeloValido },
        patente: { valor: patenteVehiculo, valido: patenteValida },
        descripcion: { valor: descripcionProblema.length, valido: descripcionValida },
        ubicacion: { valor: origenLat, valido: ubicacionValida },
        fecha: { valido: fechaValida },
        tarjeta: { valido: tarjetaValida },
        FORMULARIO_VALIDO: formValido
    });
    
    return formValido;
}

// Validar formato de email
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// Validar patente chilena
function isValidChileanPlate(plate) {
    const newFormat = /^[A-Z]{4}[0-9]{2}$/;
    const oldFormat = /^[A-Z]{2}[0-9]{4}$/;
    return newFormat.test(plate) || oldFormat.test(plate);
}

// Manejar env√≠o del formulario
function handleFormSubmit(e) {
    e.preventDefault();
    console.log('üîß Enviando solicitud de asistencia...');
    
    if (!validateForm()) {
        return;
    }
    
    // Enviar formulario
    document.getElementById('formulario-servicio').submit();
}

console.log('‚úÖ Script de asistencia mec√°nica cargado completamente');
</script>
{% endblock %}