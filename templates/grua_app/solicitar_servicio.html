{% extends 'grua_app/base.html' %}
{% load static %}

{% block title %}Grúa Style - Servicio 24/7{% endblock %}

{% block extra_css %}
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
    color: #ffffff;
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
}



/* Efectos glassmorphism base */
.glassmorphism {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px;
    padding: 32px;
    margin-bottom: 32px;
    backdrop-filter: blur(10px);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.glassmorphism::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(0, 213, 99, 0.1),
        transparent
    );
    animation: shimmer 6s infinite;
}

.glassmorphism:hover {
    transform: translateY(-2px);
    border-color: rgba(0, 213, 99, 0.3);
    box-shadow: 0 30px 60px rgba(0, 213, 99, 0.15);
}

.glassmorphism h2 {
    color: #00D563;
    margin-bottom: 24px;
    font-size: 1.8rem;
    font-weight: 600;
    text-shadow: 0 0 20px rgba(0, 213, 99, 0.3);
}

/* Animación shimmer */
@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

/* Hero Section glassmorphism */
.hero-section {
    background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
    padding: 60px 0;
    position: relative;
    overflow: hidden;
}

.hero-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 30% 50%, rgba(0, 213, 99, 0.1) 0%, transparent 50%);
}

.hero-content {
    text-align: center;
    max-width: 800px;
    margin: 0 auto;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px;
    padding: 40px;
    backdrop-filter: blur(10px);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    position: relative;
    z-index: 2;
}

.hero-title {
    font-size: clamp(2rem, 4vw, 3rem);
    font-weight: 700;
    margin-bottom: 20px;
    line-height: 1.2;
    text-shadow: 0 0 20px rgba(0, 213, 99, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.hero-title i {
    color: #00D563;
    font-size: 0.9em;
}

.hero-subtitle {
    font-size: 1.125rem;
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.6;
    margin: 0;
}

/* Service Grid glassmorphism */
.service-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
}

.service-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 32px 24px;
    color: #ffffff;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
    min-height: 180px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.service-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(0, 213, 99, 0.2),
        transparent
    );
    animation: shimmer 4s infinite;
}

.service-btn:hover {
    border-color: rgba(0, 213, 99, 0.5);
    background: rgba(0, 213, 99, 0.1);
    transform: translateY(-4px);
    box-shadow: 0 15px 40px rgba(0, 213, 99, 0.2);
}

.service-btn.active {
    background: linear-gradient(135deg, rgba(0, 213, 99, 0.2) 0%, rgba(0, 255, 117, 0.1) 100%);
    border-color: #00D563;
    box-shadow: 0 0 30px rgba(0, 213, 99, 0.4);
    transform: translateY(-4px);
}

.service-btn input[type="radio"] {
    display: none;
}

.service-icon {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #00D563, #00B853);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
    box-shadow: 0 8px 25px rgba(0, 213, 99, 0.3);
    transition: all 0.3s ease;
}

.service-icon i {
    font-size: 1.5rem;
    color: #000;
}

.service-btn:hover .service-icon,
.service-btn.active .service-icon {
    transform: scale(1.1);
    box-shadow: 0 12px 35px rgba(0, 213, 99, 0.5);
}

.service-btn h3 {
    font-size: 1.25rem;
    margin-bottom: 8px;
    color: #00D563;
    font-weight: 600;
    text-shadow: 0 0 10px rgba(0, 213, 99, 0.2);
}

.service-btn p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.95rem;
    line-height: 1.4;
    margin: 0;
}

/* Options Grid glassmorphism */
.options-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 24px 0;
}

.option-card {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 24px 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
    min-height: 140px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.option-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(0, 213, 99, 0.15),
        transparent
    );
    animation: shimmer 5s infinite;
}

.option-card:hover {
    border-color: rgba(0, 213, 99, 0.4);
    background: rgba(0, 213, 99, 0.08);
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 213, 99, 0.15);
}

.option-card.selected {
    border-color: #00D563;
    background: linear-gradient(135deg, rgba(0, 213, 99, 0.2) 0%, rgba(0, 255, 117, 0.1) 100%);
    box-shadow: 0 0 25px rgba(0, 213, 99, 0.3);
    transform: translateY(-3px);
}

.option-card input[type="radio"] {
    display: none;
}

.option-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #00D563, #00B853);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 12px;
    box-shadow: 0 6px 20px rgba(0, 213, 99, 0.3);
    transition: all 0.3s ease;
}

.option-icon i {
    font-size: 1.2rem;
    color: #000;
}

.option-card:hover .option-icon,
.option-card.selected .option-icon {
    transform: scale(1.1);
    box-shadow: 0 8px 25px rgba(0, 213, 99, 0.5);
}

.option-card h4 {
    color: #00D563;
    margin-bottom: 6px;
    font-size: 1rem;
    font-weight: 600;
    text-shadow: 0 0 8px rgba(0, 213, 99, 0.2);
}

.option-card p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.85rem;
    line-height: 1.3;
    margin: 0;
}

/* Form Elements glassmorphism */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 24px 0;
}

.form-group {
    margin-bottom: 0;
}

.form-group-full {
    grid-column: 1 / -1;
}

.form-group label {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    color: #00D563;
    font-weight: 600;
    font-size: 0.95rem;
    text-shadow: 0 0 8px rgba(0, 213, 99, 0.2);
    gap: 8px;
}

.form-group label i {
    color: #00D563;
    font-size: 0.9rem;
    width: 16px;
    text-align: center;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 14px 16px;
    background: rgba(255, 255, 255, 0.08);
    border: 2px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    color: #ffffff;
    font-size: 1rem;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: #00D563;
    background: rgba(0, 213, 99, 0.1);
    box-shadow: 0 0 20px rgba(0, 213, 99, 0.3);
    transform: translateY(-1px);
}

.form-group input::placeholder,
.form-group textarea::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.form-group input.valid {
    border-color: #00D563;
    background: rgba(0, 213, 99, 0.08);
    box-shadow: 0 0 15px rgba(0, 213, 99, 0.2);
}

.form-group input.error {
    border-color: #dc3545;
    background: rgba(220, 53, 69, 0.08);
    box-shadow: 0 0 15px rgba(220, 53, 69, 0.2);
}

/* Map Section glassmorphism */
.map-instructions {
    background: rgba(0, 213, 99, 0.08);
    border: 1px solid rgba(0, 213, 99, 0.2);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

.map-instructions::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(0, 213, 99, 0.15),
        transparent
    );
    animation: shimmer 5s infinite;
}

.map-instructions h3 {
    color: #00D563;
    margin-bottom: 16px;
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    text-shadow: 0 0 10px rgba(0, 213, 99, 0.3);
}

.map-instructions h3 i {
    font-size: 1rem;
}

.map-instructions ul {
    color: rgba(255, 255, 255, 0.9);
    padding-left: 0;
    margin: 0;
    list-style: none;
}

.map-instructions li {
    margin-bottom: 12px;
    font-size: 0.95rem;
    line-height: 1.4;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
}

.map-instructions li:last-child {
    margin-bottom: 0;
}

.map-instructions li i {
    color: #00D563;
    font-size: 0.9rem;
    width: 16px;
    text-align: center;
    flex-shrink: 0;
}

#map {
    height: 400px;
    width: 100%;
    border-radius: 20px;
    border: 2px solid rgba(0, 213, 99, 0.3);
    position: relative;
    z-index: 0;
    background: #1a1a2e;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}

#map:hover {
    border-color: rgba(0, 213, 99, 0.5);
    box-shadow: 0 15px 40px rgba(0, 213, 99, 0.15);
}

/* Ruta y Precio glassmorphism */
.ruta-seleccionada {
    display: none;
    background: rgba(0, 213, 99, 0.08);
    border: 1px solid rgba(0, 213, 99, 0.2);
    border-radius: 20px;
    padding: 24px;
    margin-top: 24px;
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

.ruta-seleccionada::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(0, 213, 99, 0.15),
        transparent
    );
    animation: shimmer 4s infinite;
}

.ruta-seleccionada h3 {
    color: #00D563;
    margin-bottom: 20px;
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    text-shadow: 0 0 15px rgba(0, 213, 99, 0.4);
}

.direccion-item {
    background: rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
}

.direccion-item:hover {
    background: rgba(255, 255, 255, 0.12);
    border-color: rgba(0, 213, 99, 0.3);
    transform: translateY(-1px);
}

.direccion-item h4 {
    color: #00D563;
    margin-bottom: 8px;
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    text-shadow: 0 0 8px rgba(0, 213, 99, 0.2);
}

.direccion-item h4 i {
    font-size: 0.9rem;
    width: 16px;
    text-align: center;
}

.direccion-item p {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.95rem;
    line-height: 1.4;
    margin: 0;
}

.precio-calculado {
    display: none;
    background: linear-gradient(135deg, rgba(0, 213, 99, 0.15) 0%, rgba(0, 255, 117, 0.08) 100%);
    border: 2px solid rgba(0, 213, 99, 0.4);
    border-radius: 20px;
    padding: 24px;
    margin-top: 20px;
    text-align: center;
    box-shadow: 0 0 30px rgba(0, 213, 99, 0.2);
    position: relative;
    overflow: hidden;
}

.precio-calculado::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(0, 213, 99, 0.2),
        transparent
    );
    animation: shimmer 3s infinite;
}

.precio-calculado h3 {
    color: #00D563;
    font-size: 1.4rem;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    text-shadow: 0 0 15px rgba(0, 213, 99, 0.4);
}

.precio-total {
    font-size: 2.2rem;
    font-weight: 700;
    color: #ffffff;
    text-shadow: 0 0 20px rgba(0, 213, 99, 0.5);
    margin-bottom: 16px;
}

.precio-desglose {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.precio-desglose p {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 8px;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.precio-desglose p:last-child {
    margin-bottom: 0;
}

.precio-desglose p i {
    color: #00D563;
    font-size: 0.9rem;
    width: 16px;
    text-align: center;
}

.precio-desglose span {
    font-weight: 600;
    color: #00D563;
}

/* Payment Methods - reutiliza los estilos de options-grid pero con mejoras específicas */
.glassmorphism .options-grid .option-card {
    min-height: 160px;
}

/* Estilos específicos para iconos de pago */
.option-card .option-icon i.fa-money-bill-wave {
    color: #000;
}

.option-card .option-icon i.fa-credit-card {
    color: #000;
}

.option-card .option-icon i.fa-university {
    color: #000;
}

/* Pasarela de Pago glassmorphism */
.pasarela-pago {
    margin-top: 32px;
    animation: slideDown 0.4s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.payment-form {
    background: rgba(0, 213, 99, 0.08) !important;
    border: 1px solid rgba(0, 213, 99, 0.2) !important;
}

.payment-form h3 {
    color: #00D563;
    margin-bottom: 24px;
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    text-shadow: 0 0 15px rgba(0, 213, 99, 0.4);
}

.security-notice {
    margin-top: 20px;
    padding: 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    gap: 12px;
}

.security-notice i {
    color: #00D563;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.security-notice p {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
    margin: 0;
    line-height: 1.4;
}



/* Responsive improvements */
@media (max-width: 768px) {
    .container {
        padding: 16px;
    }
    
    .glassmorphism {
        padding: 24px 20px;
        margin-bottom: 24px;
    }
    
    .hero-content {
        padding: 32px 24px;
    }
    
    .service-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .options-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    #map {
        height: 300px;
    }
    
    .precio-total {
        font-size: 1.8rem;
    }
}

@media (max-width: 480px) {
    .options-grid {
        grid-template-columns: 1fr;
    }
    
    .glassmorphism h2 {
        font-size: 1.5rem;
    }
    
    .hero-title {
        font-size: 2rem;
    }
}



/* Botones de servicio */
.service-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(0, 213, 99, 0.3);
    border-radius: 15px;
    padding: 1.5rem;
    color: #ffffff;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.service-btn:hover {
    border-color: #00D563;
    background: rgba(0, 213, 99, 0.1);
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0, 213, 99, 0.2);
}

.service-btn.active {
    background: linear-gradient(135deg, rgba(0, 213, 99, 0.2) 0%, rgba(0, 255, 117, 0.1) 100%);
    border-color: #00D563;
    box-shadow: 0 0 30px rgba(0, 213, 99, 0.3);
}

.service-btn input[type="radio"] {
    display: none;
}

.service-btn h3 {
    font-size: 1.3rem;
    margin-bottom: 0.5rem;
    color: #00D563;
}

.service-btn p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
}

/* Sección de fecha programada glassmorphism */
.fecha-programada {
    display: none;
    margin-top: 24px;
    background: rgba(0, 213, 99, 0.08);
    border: 1px solid rgba(0, 213, 99, 0.2);
    border-radius: 16px;
    padding: 20px;
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

.fecha-programada::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(0, 213, 99, 0.15),
        transparent
    );
    animation: shimmer 5s infinite;
}

.fecha-programada label {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    color: #00D563;
    font-weight: 600;
    gap: 8px;
    text-shadow: 0 0 8px rgba(0, 213, 99, 0.2);
}

.fecha-programada input[type="datetime-local"] {
    width: 100%;
    padding: 14px 16px;
    background: rgba(255, 255, 255, 0.08);
    border: 2px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    color: #ffffff;
    font-size: 1rem;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.fecha-programada input[type="datetime-local"]:focus {
    outline: none;
    border-color: #00D563;
    background: rgba(0, 213, 99, 0.1);
    box-shadow: 0 0 20px rgba(0, 213, 99, 0.3);
    transform: translateY(-1px);
}

/* Grid de opciones */
.options-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}

.option-card {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.option-card:hover {
    border-color: rgba(0, 213, 99, 0.5);
    background: rgba(0, 213, 99, 0.1);
}

.option-card.selected {
    border-color: #00D563;
    background: linear-gradient(135deg, rgba(0, 213, 99, 0.2) 0%, rgba(0, 255, 117, 0.1) 100%);
    box-shadow: 0 0 20px rgba(0, 213, 99, 0.3);
}

.option-card input[type="radio"] {
    display: none;
}

.option-card h4 {
    color: #00D563;
    margin-bottom: 0.5rem;
    font-size: 1rem;
}

.option-card p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.8rem;
}

/* Mapa */
#map {
    height: 400px;
    width: 100%;
    border-radius: 15px;
    border: 2px solid rgba(0, 213, 99, 0.3);
    position: relative;
    z-index: 0;
    background: #1a1a2e;
}

/* Instrucciones del mapa */
.map-instructions {
    background: rgba(0, 213, 99, 0.1);
    border: 1px solid rgba(0, 213, 99, 0.3);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
    position: relative;
    z-index: 10;
}

.map-instructions h3 {
    color: #00D563;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
}

.map-instructions ul {
    color: rgba(255, 255, 255, 0.8);
    padding-left: 1.2rem;
}

.map-instructions li {
    margin-bottom: 0.3rem;
    font-size: 0.9rem;
}

/* Sección de ruta */
.ruta-seleccionada {
    display: none;
    background: rgba(0, 213, 99, 0.1);
    border: 1px solid rgba(0, 213, 99, 0.3);
    border-radius: 10px;
    padding: 1.5rem;
    margin-top: 1rem;
}

.ruta-seleccionada h3 {
    color: #00D563;
    margin-bottom: 1rem;
    font-size: 1.3rem;
}

.direccion-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.direccion-item h4 {
    color: #00D563;
    margin-bottom: 0.5rem;
    font-size: 1rem;
}

.direccion-item p {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
}

/* Calculadora de precio */
.precio-calculado {
    display: none;
    background: linear-gradient(135deg, rgba(0, 213, 99, 0.2) 0%, rgba(0, 255, 117, 0.1) 100%);
    border: 2px solid rgba(0, 213, 99, 0.5);
    border-radius: 15px;
    padding: 2rem;
    margin-top: 1rem;
    text-align: center;
    box-shadow: 0 0 30px rgba(0, 213, 99, 0.2);
}

.precio-calculado h3 {
    color: #00D563;
    font-size: 1.5rem;
    margin-bottom: 1rem;
}

.precio-total {
    font-size: 2rem;
    font-weight: 700;
    color: #ffffff;
    text-shadow: 0 0 20px rgba(0, 213, 99, 0.5);
}

.precio-desglose {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.precio-desglose p {
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

/* Formulario */
.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #00D563;
    font-weight: 500;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 0.8rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: #ffffff;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: #00D563;
    box-shadow: 0 0 10px rgba(0, 213, 99, 0.3);
}

/* Pasarela de pago */
.pasarela-pago {
    margin-top: 2rem;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.pasarela-pago .form-group input {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 0.8rem;
    color: #ffffff;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.pasarela-pago .form-group input:focus {
    outline: none;
    border-color: #00D563;
    box-shadow: 0 0 15px rgba(0, 213, 99, 0.3);
    background: rgba(0, 213, 99, 0.1);
}

.pasarela-pago .form-group input.error {
    border-color: #dc3545;
    box-shadow: 0 0 15px rgba(220, 53, 69, 0.3);
}

.pasarela-pago .form-group input.valid {
    border-color: #00D563;
    box-shadow: 0 0 10px rgba(0, 213, 99, 0.2);
}

/* Responsive para la pasarela */
@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .form-group[style*="grid-column: 1 / -1"] {
        grid-column: 1;
    }
    
    .hero h1 {
        font-size: 2rem;
    }
    
    .service-grid {
        grid-template-columns: 1fr;
    }
    
    .options-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .glassmorphism {
        padding: 1rem;
    }
    
    #map {
        height: 300px;
    }
}

@media (max-width: 480px) {
    .options-grid {
        grid-template-columns: 1fr;
    }
    
    .precio-total {
        font-size: 1.5rem;
    }
}

/* Submit Button glassmorphism - SOLUCIÓN FINAL */
button#btn-enviar.submit-btn {
    background: linear-gradient(135deg, #00D563 0%, #00ff75 100%) !important;
    border: none !important;
    border-radius: 16px !important;
    padding: 18px 32px !important;
    color: #ffffff !important;
    font-size: 1.1rem !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    width: 100% !important;
    margin-top: 32px !important;
    text-transform: uppercase !important;
    letter-spacing: 1px !important;
    box-shadow: 0 8px 25px rgba(0, 213, 99, 0.3) !important;
    position: relative !important;
    overflow: hidden !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 12px !important;
    backdrop-filter: blur(10px) !important;
    min-height: auto !important;
}

button#btn-enviar.submit-btn::before {
    content: '' !important;
    position: absolute !important;
    top: 0 !important;
    left: -100% !important;
    width: 100% !important;
    height: 100% !important;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent) !important;
    animation: shimmer 3s infinite !important;
}

button#btn-enviar.submit-btn:hover {
    transform: translateY(-4px) !important;
    box-shadow: 0 15px 40px rgba(0, 213, 99, 0.4) !important;
    background: linear-gradient(135deg, #00B853 0%, #00D563 100%) !important;
}

button#btn-enviar.submit-btn:disabled {
    background: rgba(255, 255, 255, 0.1) !important;
    color: rgba(255, 255, 255, 0.5) !important;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
}
</style>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title">
                
                Solicitar Servicio de Grúa
            </h1>
            <p class="hero-subtitle">
                Servicio de grúa las 24 horas del día, los 7 días de la semana
            </p>
        </div>
    </div>
</section>

<div class="container">
    <!-- Tipo de Servicio -->
    <!-- Tipo de Servicio -->
<section class="glassmorphism">
    <h2>Tipo de Servicio</h2>
    <div class="service-grid">
        <div class="service-btn" onclick="selectService('inmediato')">
            <input type="radio" name="tipo_servicio" value="inmediato" id="servicio_inmediato">
            <div class="service-icon">
                <i class="fas fa-bolt"></i>
            </div>
            <h3>Servicio Inmediato</h3>
            <p>Atención en el menor tiempo posible</p>
        </div>
        <div class="service-btn" onclick="selectService('programado')">
            <input type="radio" name="tipo_servicio" value="programado" id="servicio_programado">
            <div class="service-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <h3>Servicio Programado</h3>
            <p>Programa tu servicio para una fecha específica</p>
        </div>
    </div>
        
        <div id="fecha-programada" class="fecha-programada">
            <label for="fecha_hora">Fecha y Hora del Servicio:</label>
            <input type="datetime-local" id="fecha_hora" name="fecha_hora">
        </div>
    </section>

    <!-- Selección de Vehículo -->
<section class="glassmorphism">
    <h2>Tipo de Vehículo</h2>
    <div class="options-grid">
        <div class="option-card" onclick="selectOption('vehiculo', 'auto')">
            <input type="radio" name="tipo_vehiculo" value="auto" id="vehiculo_auto">
            <div class="option-icon">
                <i class="fas fa-car"></i>
            </div>
            <h4>Auto</h4>
            <p>Vehículos livianos</p>
        </div>
        <div class="option-card" onclick="selectOption('vehiculo', 'camioneta')">
            <input type="radio" name="tipo_vehiculo" value="camioneta" id="vehiculo_camioneta">
            <div class="option-icon">
                <i class="fas fa-truck-pickup"></i>
            </div>
            <h4>Camioneta</h4>
            <p>Pick-up y SUV</p>
        </div>
        <div class="option-card" onclick="selectOption('vehiculo', 'moto')">
            <input type="radio" name="tipo_vehiculo" value="moto" id="vehiculo_moto">
            <div class="option-icon">
                <i class="fas fa-motorcycle"></i>
            </div>
            <h4>Motocicleta</h4>
            <p>Motos y scooters</p>
        </div>
        <div class="option-card" onclick="selectOption('vehiculo', 'camion')">
            <input type="radio" name="tipo_vehiculo" value="camion" id="vehiculo_camion">
            <div class="option-icon">
                <i class="fas fa-truck"></i>
            </div>
            <h4>Camión</h4>
            <p>Vehículos pesados</p>
        </div>
    </div>
</section>

    

    <!-- Mapa de Ubicación -->
<section class="glassmorphism">
    <h2>
        <i class="fas fa-map-marked-alt" style="margin-right: 10px; font-size: 0.9em;"></i>
        Ubicación del Servicio
    </h2>
    
    <div class="map-instructions">
        <h3>
            <i class="fas fa-info-circle"></i>
            Instrucciones:
        </h3>
        <ul>
            <li>
                <i class="fas fa-mouse-pointer"></i>
                Primer clic: Selecciona el punto de origen (donde recoger el vehículo)
            </li>
            <li>
                <i class="fas fa-mouse-pointer"></i>
                Segundo clic: Selecciona el destino (donde llevar el vehículo)
            </li>
            <li>
                <i class="fas fa-arrows-alt"></i>
                Puedes arrastrar los marcadores para ajustar las ubicaciones
            </li>
        </ul>
    </div>
    
    <div id="map"></div>
        
        <div id="ruta-seleccionada" class="ruta-seleccionada">
            <h3>
                <i class="fas fa-route"></i>
                Ruta Seleccionada
            </h3>
            <div id="direccion-origen" class="direccion-item">
                <h4>
                    <i class="fas fa-play"></i>
                    Origen:
                </h4>
                <p id="texto-origen">Selecciona un punto en el mapa</p>
            </div>
            <div id="direccion-destino" class="direccion-item">
                <h4>
                    <i class="fas fa-flag-checkered"></i>
                    Destino:
                </h4>
                <p id="texto-destino">Selecciona el destino en el mapa</p>
            </div>
            <div id="precio-calculado" class="precio-calculado">
                <h3>
                    <i class="fas fa-calculator"></i>
                    Precio Estimado
                </h3>
                <div class="precio-total" id="precio-total">$0</div>
                <div class="precio-desglose">
                    <p><i class="fas fa-road"></i> Distancia: <span id="distancia-text">0 km</span></p>
                    <p><i class="fas fa-tag"></i> Precio base: <span id="precio-base">${{ tarifa_base|floatformat:0 }}</span></p>
                    <p><i class="fas fa-plus"></i> Precio por km: <span id="precio-km">$0</span></p>
                </div>
            </div>
        </div>
    </section>

    <!-- Método de Pago -->
<section class="glassmorphism">
    <h2>
        <i class="fas fa-credit-card" style="margin-right: 10px; font-size: 0.9em;"></i>
        Método de Pago
    </h2>
    <div class="options-grid">
        <div class="option-card" onclick="selectOption('pago', 'efectivo')">
            <input type="radio" name="metodo_pago" value="efectivo" id="pago_efectivo">
            <div class="option-icon">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <h4>Efectivo</h4>
            <p>Pago en efectivo</p>
        </div>
        <div class="option-card" onclick="selectOption('pago', 'mercadopago_card')">
            <input type="radio" name="metodo_pago" value="mercadopago_card" id="pago_mercadopago_card">
            <div class="option-icon">
                <i class="fas fa-credit-card"></i>
            </div>
            <h4>Tarjeta</h4>
            <p>Pago con tarjeta</p>
        </div>
        <div class="option-card" onclick="selectOption('pago', 'transferencia')">
            <input type="radio" name="metodo_pago" value="transferencia" id="pago_transferencia">
            <div class="option-icon">
                <i class="fas fa-university"></i>
            </div>
            <h4>Transferencia</h4>
            <p>Transferencia bancaria</p>
        </div>
    </div>
        
        <!-- Sección de pasarela de pago (oculta por defecto) -->
        <div id="pasarela-pago" class="pasarela-pago" style="display: none;">
            <div class="glassmorphism payment-form">
                <h3>
                    <i class="fas fa-credit-card"></i>
                    Información de Tarjeta
                </h3>
                
                <div class="form-grid">
                    <div class="form-group form-group-full">
                        <label for="numero_tarjeta">
                            <i class="fas fa-credit-card"></i>
                            Número de Tarjeta
                        </label>
                        <input type="text" id="numero_tarjeta" name="numero_tarjeta" placeholder="1234 5678 9012 3456" maxlength="19">
                    </div>
                    
                    <div class="form-group">
                        <label for="fecha_vencimiento">
                            <i class="fas fa-calendar-alt"></i>
                            Vencimiento
                        </label>
                        <input type="text" id="fecha_vencimiento" name="fecha_vencimiento" placeholder="MM/AA" maxlength="5">
                    </div>
                    
                    <div class="form-group">
                        <label for="cvv">
                            <i class="fas fa-lock"></i>
                            CVV
                        </label>
                        <input type="text" id="cvv" name="cvv" placeholder="123" maxlength="4">
                    </div>
                    
                    <div class="form-group form-group-full">
                        <label for="nombre_titular">
                            <i class="fas fa-user"></i>
                            Nombre del Titular
                        </label>
                        <input type="text" id="nombre_titular" name="nombre_titular" placeholder="Nombre como aparece en la tarjeta">
                    </div>
                </div>
                
                <div class="security-notice">
                    <i class="fas fa-shield-alt"></i>
                    <p>Tu información está segura. Utilizamos encriptación SSL para proteger tus datos.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Datos del Cliente -->
<section class="glassmorphism">
    <h2>
        <i class="fas fa-user" style="margin-right: 10px; font-size: 0.9em;"></i>
        Datos del Cliente
    </h2>
    <form id="formulario-servicio" method="post">
        {% csrf_token %}

        <!-- Información del Vehículo -->
<section class="glassmorphism">
    <h2>
        <i class="fas fa-info-circle" style="margin-right: 10px; font-size: 0.9em;"></i>
        Información del Vehículo
    </h2>
    
    <div class="form-grid">
        <div class="form-group">
            <label for="marca_vehiculo">
                <i class="fas fa-industry"></i>
                Marca del Vehículo *
            </label>
            <input type="text" id="marca_vehiculo" name="marca_vehiculo" placeholder="Ej: Toyota, Chevrolet, Ford" required>
        </div>
        
        <div class="form-group">
            <label for="modelo_vehiculo">
                <i class="fas fa-car-side"></i>
                Modelo del Vehículo *
            </label>
            <input type="text" id="modelo_vehiculo" name="modelo_vehiculo" placeholder="Ej: Corolla, Aveo, Fiesta" required>
        </div>
        
        <div class="form-group form-group-full">
            <label for="patente_vehiculo">
                <i class="fas fa-id-card"></i>
                Patente del Vehículo *
            </label>
            <input type="text" id="patente_vehiculo" name="placa_vehiculo" placeholder="Ej: ABCD12, AB1234" maxlength="6" style="text-transform: uppercase;" required>
        </div>
    </div>
</section>
        
        <div class="form-grid">
            <div class="form-group">
                <label for="nombre">
                    <i class="fas fa-user"></i>
                    Nombre Completo *
                </label>
                <input type="text" id="nombre" name="nombre" required>
            </div>
            
            <div class="form-group">
                <label for="telefono">
                    <i class="fas fa-phone"></i>
                    Teléfono *
                </label>
                <input type="tel" id="telefono" name="telefono" required>
            </div>
        </div>
        
        <div class="form-group">
            <label for="email">
                <i class="fas fa-envelope"></i>
                Email
            </label>
            <input type="email" id="email" name="email">
        </div>
        
        <div class="form-group">
            <label for="comentarios">
                <i class="fas fa-comment-alt"></i>
                Comentarios Adicionales
            </label>
            <textarea id="comentarios" name="comentarios" rows="4" placeholder="Describe cualquier información adicional sobre tu vehículo o el servicio..."></textarea>
        </div>
            
            <!-- Campos ocultos para los datos del servicio -->
            <input type="hidden" id="hidden_tipo_servicio" name="tipo_servicio">
            <input type="hidden" id="hidden_fecha_hora" name="fecha_servicio">
            <input type="hidden" id="hidden_tipo_vehiculo" name="tipo_vehiculo">
            <input type="hidden" id="hidden_metodo_pago" name="metodo_pago">
            <input type="hidden" id="hidden_origen_lat" name="origen_lat">
            <input type="hidden" id="hidden_origen_lng" name="origen_lng">
            <input type="hidden" id="hidden_destino_lat" name="destino_lat">
            <input type="hidden" id="hidden_destino_lng" name="destino_lng">
            <input type="hidden" id="hidden_origen_direccion" name="direccion_origen">
            <input type="hidden" id="hidden_destino_direccion" name="direccion_destino">
            <input type="hidden" id="hidden_distancia" name="distancia_km">
            <input type="hidden" id="hidden_precio_total" name="costo_total">
            <input type="hidden" id="hidden_descripcion_problema" name="descripcion_problema" value="Solicitud de servicio de grúa">
            
            <button type="submit" id="btn-enviar" class="submit-btn" disabled>
                 Solicitar Servicio de Grúa
            </button>
        </form>
    </section>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
console.log('🚀 Iniciando aplicación de grúa...');

// Variables globales
let map;
let origenMarker = null;
let destinoMarker = null;
let routeControl = null;
let clickCount = 0;
let distanciaKm = 0;

// Precios base según membresía del usuario
const PRECIO_BASE = {{ tarifa_base }};
const PRECIO_POR_KM = {{ tarifa_por_km }};

// Inicialización cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    console.log('✅ DOM cargado, iniciando mapa...');
    initMap();
    setupEventListeners();
});

// Inicializar el mapa
function initMap() {
    try {
        console.log('🗺️ Verificando disponibilidad de Leaflet...');
        if (typeof L === 'undefined') {
            console.error('❌ Leaflet no está disponible');
            return;
        }
        console.log('✅ Leaflet disponible, creando mapa...');
        
        // Crear el mapa centrado en Santiago, Chile
        map = L.map('map').setView([-33.4489, -70.6693], 12);
        console.log('✅ Mapa creado, agregando tiles...');
        
        // Agregar tiles de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        console.log('✅ Tiles agregados');
        
        // Event listener para clicks en el mapa
        map.on('click', onMapClick);
        console.log('✅ Event listener agregado');
        
        console.log('✅ Mapa completamente inicializado');
        
    } catch (error) {
        console.error('❌ Error inicializando mapa:', error);
    }
}

// Manejar clicks en el mapa
function onMapClick(e) {
    console.log('🖱️ Click en mapa:', e.latlng, 'Contador:', clickCount);
    
    if (clickCount === 0) {
        // Primer click - origen
        console.log('🏁 Estableciendo origen...');
        if (origenMarker) {
            map.removeLayer(origenMarker);
        }
        
        origenMarker = L.marker(e.latlng, {
            draggable: true,
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).addTo(map);
        
        origenMarker.bindPopup('🏁 Origen').openPopup();
        
        // Event listener para el drag del marcador origen
        origenMarker.on('dragend', function() {
            console.log('🏁 Origen movido:', origenMarker.getLatLng());
            updateRoute();
        });
        
        // Obtener dirección del origen
        reverseGeocode(e.latlng, 'origen');
        
        clickCount = 1;
        
    } else if (clickCount === 1) {
        // Segundo click - destino
        console.log('🎯 Estableciendo destino...');
        if (destinoMarker) {
            map.removeLayer(destinoMarker);
        }
        
        destinoMarker = L.marker(e.latlng, {
            draggable: true,
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).addTo(map);
        
        destinoMarker.bindPopup('🎯 Destino').openPopup();
        
        // Event listener para el drag del marcador destino
        destinoMarker.on('dragend', function() {
            console.log('🎯 Destino movido:', destinoMarker.getLatLng());
            updateRoute();
        });
        
        // Obtener dirección del destino
        reverseGeocode(e.latlng, 'destino');
        
        // Mostrar sección de ruta
        document.getElementById('ruta-seleccionada').style.display = 'block';
        
        // Calcular ruta
        calculateRoute();
        
        clickCount = 2;
        
    } else {
        // Clicks adicionales - reset
        console.log('🔄 Reset del mapa...');
        resetMap();
        onMapClick(e); // Llamar recursivamente para establecer nuevo origen
    }
}

// Calcular ruta entre origen y destino
function calculateRoute() {
    if (!origenMarker || !destinoMarker) return;
    
    console.log('🗺️ Calculando ruta...');
    const origen = origenMarker.getLatLng();
    const destino = destinoMarker.getLatLng();
    
    // Usar OSRM para calcular la ruta
    const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${origen.lng},${origen.lat};${destino.lng},${destino.lat}?overview=full&geometries=geojson`;
    
    fetch(osrmUrl)
        .then(response => response.json())
        .then(data => {
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                
                // Remover ruta anterior si existe
                if (routeControl) {
                    map.removeLayer(routeControl);
                }
                
                // Dibujar nueva ruta
                const coordinates = route.geometry.coordinates;
                const latLngs = coordinates.map(coord => [coord[1], coord[0]]);
                
                routeControl = L.polyline(latLngs, {
                    color: '#00D563',
                    weight: 4,
                    opacity: 0.7
                }).addTo(map);
                
                // Ajustar vista del mapa para mostrar toda la ruta
                map.fitBounds(routeControl.getBounds(), {padding: [20, 20]});
                
                // Calcular distancia
                distanciaKm = (route.distance / 1000).toFixed(1);
                console.log('📏 Distancia calculada:', distanciaKm, 'km');
                
                // Actualizar precio si hay un vehículo seleccionado
                updatePrice();
                
            } else {
                console.error('❌ No se pudo calcular la ruta');
                // Calcular distancia directa como fallback
                const distanciaDirecta = origen.distanceTo(destino) / 1000;
                distanciaKm = distanciaDirecta.toFixed(1);
                updatePrice();
            }
        })
        .catch(error => {
            console.error('❌ Error calculando ruta:', error);
            // Calcular distancia directa como fallback
            const distanciaDirecta = origen.distanceTo(destino) / 1000;
            distanciaKm = distanciaDirecta.toFixed(1);
            updatePrice();
        });
}

// Actualizar ruta cuando se mueven los marcadores
function updateRoute() {
    if (origenMarker && destinoMarker) {
        calculateRoute();
        // Actualizar direcciones
        reverseGeocode(origenMarker.getLatLng(), 'origen');
        reverseGeocode(destinoMarker.getLatLng(), 'destino');
    }
}

function reverseGeocode(latlng, tipo) {
    console.log(`📍 Obteniendo dirección para ${tipo}:`, latlng);
    
    // Usar tu API de geocodificación en lugar de Nominatim directamente
    fetch('/api/geocodificar/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            lat: latlng.lat,
            lng: latlng.lng
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.direccion) {
            const direccion = data.direccion;
            console.log(`✅ Dirección ${tipo}:`, direccion);
            
            if (tipo === 'origen') {
                document.getElementById('texto-origen').textContent = direccion;
                document.getElementById('hidden_origen_lat').value = latlng.lat;
                document.getElementById('hidden_origen_lng').value = latlng.lng;
                document.getElementById('hidden_origen_direccion').value = direccion;
            } else {
                document.getElementById('texto-destino').textContent = direccion;
                document.getElementById('hidden_destino_lat').value = latlng.lat;
                document.getElementById('hidden_destino_lng').value = latlng.lng;
                document.getElementById('hidden_destino_direccion').value = direccion;
            }
            
            validateForm();
        } else {
            // Fallback a coordenadas
            document.getElementById(`texto-${tipo}`).textContent = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
        }
    })
    .catch(error => {
        console.error(`❌ Error obteniendo dirección para ${tipo}:`, error);
        document.getElementById(`texto-${tipo}`).textContent = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
    });
}

// Reset del mapa
function resetMap() {
    console.log('🔄 Reseteando mapa...');
    
    if (origenMarker) {
        map.removeLayer(origenMarker);
        origenMarker = null;
    }
    
    if (destinoMarker) {
        map.removeLayer(destinoMarker);
        destinoMarker = null;
    }
    
    if (routeControl) {
        map.removeLayer(routeControl);
        routeControl = null;
    }
    
    clickCount = 0;
    distanciaKm = 0;
    
    document.getElementById('ruta-seleccionada').style.display = 'none';
    document.getElementById('precio-calculado').style.display = 'none';
    
    // Limpiar campos ocultos
    document.getElementById('hidden_origen_lat').value = '';
    document.getElementById('hidden_origen_lng').value = '';
    document.getElementById('hidden_destino_lat').value = '';
    document.getElementById('hidden_destino_lng').value = '';
    document.getElementById('hidden_origen_direccion').value = '';
    document.getElementById('hidden_destino_direccion').value = '';
    document.getElementById('hidden_distancia').value = '';
    document.getElementById('hidden_precio_total').value = '';
    
    validateForm();
}

// Configurar event listeners
function setupEventListeners() {
    console.log('🎧 Configurando event listeners...');
    
    // Formulario
    document.getElementById('formulario-servicio').addEventListener('submit', handleFormSubmit);
    
    // Campos del formulario para validación en tiempo real
    document.getElementById('nombre').addEventListener('input', validateForm);
    document.getElementById('telefono').addEventListener('input', validateForm);
    document.getElementById('email').addEventListener('input', validateForm);
    document.getElementById('marca_vehiculo').addEventListener('input', validateForm);
    document.getElementById('modelo_vehiculo').addEventListener('input', validateForm);
    document.getElementById('patente_vehiculo').addEventListener('input', validateForm);
    document.getElementById('fecha_hora').addEventListener('change', function() {
        document.getElementById('hidden_fecha_hora').value = this.value;
        validateForm();
    });
    
    // Validación de teléfono (solo números y algunos caracteres especiales)
    document.getElementById('telefono').addEventListener('input', function(e) {
        let value = e.target.value;
        // Remover caracteres no permitidos
        value = value.replace(/[^0-9+\-\(\)\s]/g, '');
        e.target.value = value;
    });
    
    // Validación de email
    document.getElementById('email').addEventListener('blur', function(e) {
        const email = e.target.value;
        if (email && !isValidEmail(email)) {
            showErrorMessage('Por favor ingresa un email válido');
            e.target.focus();
        }
    });
    
    // Validación de patente chilena
    document.getElementById('patente_vehiculo').addEventListener('input', function(e) {
        let value = e.target.value.toUpperCase();
        // Remover caracteres no permitidos (solo letras y números)
        value = value.replace(/[^A-Z0-9]/g, '');
        
        // Limitar a 6 caracteres máximo
        if (value.length > 6) {
            value = value.substring(0, 6);
        }
        
        e.target.value = value;
        
        // Validar formato
        if (e.target.value.length >= 5) {
            if (isValidChileanPlate(e.target.value)) {
                e.target.classList.add('valid');
                e.target.classList.remove('error');
            } else {
                e.target.classList.add('error');
                e.target.classList.remove('valid');
            }
        } else {
            e.target.classList.remove('valid', 'error');
        }
        
        validateForm();
    });
    setupCreditCardListeners();
}

// Configurar validaciones para campos de tarjeta
function setupCreditCardListeners() {
    console.log('💳 Configurando validaciones de tarjeta...');
    
    // Formatear número de tarjeta
    document.getElementById('numero_tarjeta').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Solo números
        value = value.replace(/(\d{4})(?=\d)/g, '$1 '); // Agregar espacios cada 4 dígitos
        e.target.value = value;
        
        // Validar número de tarjeta
        if (value.replace(/\s/g, '').length >= 13) {
            if (isValidCreditCard(value.replace(/\s/g, ''))) {
                e.target.classList.add('valid');
                e.target.classList.remove('error');
            } else {
                e.target.classList.add('error');
                e.target.classList.remove('valid');
            }
        } else {
            e.target.classList.remove('valid', 'error');
        }
        
        validateForm();
    });
    
    // Formatear fecha de vencimiento
    document.getElementById('fecha_vencimiento').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Solo números
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
        
        // Validar fecha
        if (value.length === 5) {
            if (isValidExpiryDate(value)) {
                e.target.classList.add('valid');
                e.target.classList.remove('error');
            } else {
                e.target.classList.add('error');
                e.target.classList.remove('valid');
            }
        } else {
            e.target.classList.remove('valid', 'error');
        }
        
        validateForm();
    });
    
    // Validar CVV
    document.getElementById('cvv').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Solo números
        e.target.value = value;
        
        if (value.length >= 3) {
            e.target.classList.add('valid');
            e.target.classList.remove('error');
        } else {
            e.target.classList.remove('valid', 'error');
        }
        
        validateForm();
    });
    
    // Validar nombre del titular
    document.getElementById('nombre_titular').addEventListener('input', function(e) {
        const value = e.target.value.trim();
        
        if (value.length >= 3) {
            e.target.classList.add('valid');
            e.target.classList.remove('error');
        } else {
            e.target.classList.remove('valid', 'error');
        }
        
        validateForm();
    });
}

// Validar número de tarjeta usando algoritmo de Luhn
function isValidCreditCard(number) {
    if (!/^\d{13,19}$/.test(number)) return false;
    
    let sum = 0;
    let alternate = false;
    
    for (let i = number.length - 1; i >= 0; i--) {
        let n = parseInt(number.charAt(i), 10);
        
        if (alternate) {
            n *= 2;
            if (n > 9) {
                n = (n % 10) + 1;
            }
        }
        
        sum += n;
        alternate = !alternate;
    }
    
    return (sum % 10) === 0;
}

// Validar fecha de vencimiento
function isValidExpiryDate(date) {
    const [month, year] = date.split('/');
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear() % 100;
    const currentMonth = currentDate.getMonth() + 1;
    
    const inputMonth = parseInt(month, 10);
    const inputYear = parseInt(year, 10);
    
    if (inputMonth < 1 || inputMonth > 12) return false;
    if (inputYear < currentYear) return false;
    if (inputYear === currentYear && inputMonth < currentMonth) return false;
    
    return true;
}

// Validar formato de email
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// Validar patente chilena
function isValidChileanPlate(plate) {
    // Formato nuevo: 4 letras + 2 números (CCVG65)
    const newFormat = /^[A-Z]{4}[0-9]{2}$/;
    // Formato antiguo: 2 letras + 4 números (AB1234)
    const oldFormat = /^[A-Z]{2}[0-9]{4}$/;
    
    const esFormatoNuevo = newFormat.test(plate);
    const esFormatoAntiguo = oldFormat.test(plate);
    const esValida = esFormatoNuevo || esFormatoAntiguo;
    
    console.log('🚗 Validando patente:', plate, {
        longitud: plate.length,
        formatoNuevo: esFormatoNuevo,
        formatoAntiguo: esFormatoAntiguo,
        esValida: esValida,
        patron: plate.length === 6 ? 'LLLLNN o LLNNNN' : 'Longitud incorrecta'
    });
    
    return esValida;
}
function isValidChileanPhone(phone) {
    // Formato: +56912345678 o 912345678 o +56 9 1234 5678
    const phoneRegex = /^(\+?56\s?)?[89]\d{8}$/;
    const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
    return phoneRegex.test(cleanPhone);
}

// Seleccionar tipo de servicio
function selectService(tipo) {
    console.log('🚨 Seleccionando servicio:', tipo);
    
    // Remover clase active de todos los botones de servicio
    document.querySelectorAll('.service-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Agregar clase active al botón seleccionado
    event.currentTarget.classList.add('active');
    
    // Marcar el radio button
    document.getElementById(`servicio_${tipo}`).checked = true;
    document.getElementById('hidden_tipo_servicio').value = tipo;
    
    // Mostrar/ocultar sección de fecha programada
    const fechaProgramada = document.getElementById('fecha-programada');
    if (tipo === 'programado') {
        fechaProgramada.style.display = 'block';
        document.getElementById('fecha_hora').required = true;
    } else {
    fechaProgramada.style.display = 'none';
    document.getElementById('fecha_hora').required = false;
    document.getElementById('fecha_hora').value = '';
    
    // 🆕 AGREGAR FECHA ACTUAL PARA SERVICIO INMEDIATO
    const ahora = new Date();
    const fechaActual = ahora.toISOString().slice(0, 16); // formato datetime-local
    document.getElementById('hidden_fecha_hora').value = fechaActual;
}
    
    validateForm();
}

// Seleccionar opción (vehículo o pago)
function selectOption(categoria, valor) {
    console.log(`🚗 Seleccionando ${categoria}:`, valor);
    
    // Remover clase selected de todas las cards de la categoría
    if (categoria === 'vehiculo') {
        // Remover selected de todas las cards de vehículo
        document.querySelectorAll('.option-card').forEach(card => {
            const input = card.querySelector('input[name="tipo_vehiculo"]');
            if (input) {
                card.classList.remove('selected');
            }
        });
        
        // Marcar el radio button y agregar clase selected
        document.getElementById(`vehiculo_${valor}`).checked = true;
        document.getElementById('hidden_tipo_vehiculo').value = valor;
        event.currentTarget.classList.add('selected');
        updatePrice(); // Actualizar precio cuando se selecciona vehículo
        
    } else if (categoria === 'pago') {
        // Remover selected de todas las cards de pago
        document.querySelectorAll('.option-card').forEach(card => {
            const input = card.querySelector('input[name="metodo_pago"]');
            if (input) {
                card.classList.remove('selected');
            }
        });
        
        // Marcar el radio button y agregar clase selected
        if (valor === 'mercadopago_card') {
            document.getElementById('pago_mercadopago_card').checked = true;
            // Mostrar pasarela de pago
            document.getElementById('pasarela-pago').style.display = 'block';
        } else {
            document.getElementById(`pago_${valor}`).checked = true;
            // Ocultar pasarela de pago
            document.getElementById('pasarela-pago').style.display = 'none';
        }
        document.getElementById('hidden_metodo_pago').value = valor;
        event.currentTarget.classList.add('selected');
    }
    
    validateForm();
}

// Actualizar precio según distancia y tipo de vehículo
function updatePrice() {
    const tipoVehiculo = document.getElementById('hidden_tipo_vehiculo').value;
    
    if (!tipoVehiculo || !distanciaKm) {
        document.getElementById('precio-calculado').style.display = 'none';
        return;
    }
    
    console.log('💰 Calculando precio...', { tipoVehiculo, distanciaKm });
    
    // Calcular precio total
    const precioKm = parseFloat(distanciaKm) * PRECIO_POR_KM;
    const precioTotal = PRECIO_BASE + precioKm;
    
    // Mostrar precio calculado
    document.getElementById('precio-calculado').style.display = 'block';
    document.getElementById('precio-total').textContent = `${precioTotal.toLocaleString('es-CL')}`;
    document.getElementById('distancia-text').textContent = `${distanciaKm} km`;
    document.getElementById('precio-km').textContent = `${precioKm.toLocaleString('es-CL')}`;
    
    // Guardar valores en campos ocultos
    document.getElementById('hidden_distancia').value = distanciaKm;
    document.getElementById('hidden_precio_total').value = precioTotal;
    
    console.log('✅ Precio calculado:', precioTotal);
}

// Validar formulario
function validateForm() {
    console.log('✅ Validando formulario...');
    
    const tipoServicio = document.getElementById('hidden_tipo_servicio').value;
    const tipoVehiculo = document.getElementById('hidden_tipo_vehiculo').value;
    const metodoPago = document.getElementById('hidden_metodo_pago').value;
    const nombre = document.getElementById('nombre').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    const email = document.getElementById('email').value.trim();
    const marcaVehiculo = document.getElementById('marca_vehiculo').value.trim();
    const modeloVehiculo = document.getElementById('modelo_vehiculo').value.trim();
    const patenteVehiculo = document.getElementById('patente_vehiculo').value.trim();
    const origenLat = document.getElementById('hidden_origen_lat').value;
    const destinoLat = document.getElementById('hidden_destino_lat').value;
    
    // Validaciones específicas
    const nombreValido = nombre.length >= 2;
    const telefonoValido = telefono.length >= 8; // Mínimo 8 dígitos
    const emailValido = !email || isValidEmail(email); // Email opcional pero si se ingresa debe ser válido
    const marcaValida = marcaVehiculo.length >= 2;
    const modeloValido = modeloVehiculo.length >= 2;
    const patenteValida = patenteVehiculo.length >= 5 && isValidChileanPlate(patenteVehiculo);
    
    // Validar campos de tarjeta si el método de pago es tarjeta
    let tarjetaValida = true;
    if (metodoPago === 'tarjeta') {
        const numeroTarjeta = document.getElementById('numero_tarjeta').value.replace(/\s/g, '');
        const fechaVencimiento = document.getElementById('fecha_vencimiento').value;
        const cvv = document.getElementById('cvv').value;
        const nombreTitular = document.getElementById('nombre_titular').value.trim();
        
        const validacionNumero = numeroTarjeta.length >= 13 && isValidCreditCard(numeroTarjeta);
        const validacionFecha = fechaVencimiento.length === 5 && isValidExpiryDate(fechaVencimiento);
        const validacionCvv = cvv.length >= 3;
        const validacionTitular = nombreTitular.length >= 3;
        
        tarjetaValida = validacionNumero && validacionFecha && validacionCvv && validacionTitular;
        
        console.log('💳 Validación de tarjeta detallada:', {
            numeroTarjeta: numeroTarjeta,
            numeroLength: numeroTarjeta.length,
            numeroValido: validacionNumero,
            fechaVencimiento: fechaVencimiento,
            fechaLength: fechaVencimiento.length,
            fechaValida: validacionFecha,
            cvv: cvv,
            cvvLength: cvv.length,
            cvvValido: validacionCvv,
            nombreTitular: nombreTitular,
            titularLength: nombreTitular.length,
            titularValido: validacionTitular,
            tarjetaValidaGeneral: tarjetaValida
        });
        
        // También verificar si la pasarela está visible
        const pasarelaVisible = document.getElementById('pasarela-pago').style.display !== 'none';
        console.log('👀 Pasarela visible:', pasarelaVisible);
    }
    
    let fechaValida = true;
    if (tipoServicio === 'programado') {
        const fechaHora = document.getElementById('fecha_hora').value;
        fechaValida = !!fechaHora;
        
        // Validar que la fecha sea futura
        if (fechaHora) {
            const fechaSeleccionada = new Date(fechaHora);
            const ahora = new Date();
            fechaValida = fechaSeleccionada > ahora;
            
            if (!fechaValida) {
                // Mostrar error si la fecha es pasada
                document.getElementById('fecha_hora').style.borderColor = '#dc3545';
            } else {
                document.getElementById('fecha_hora').style.borderColor = '#00D563';
            }
        }
        
        document.getElementById('hidden_fecha_hora').value = fechaHora;
    }
    
    // Validar ubicaciones
    const ubicacionValida = origenLat && destinoLat && parseFloat(origenLat) !== 0 && parseFloat(destinoLat) !== 0;
    
    const formValido = tipoServicio && 
                      tipoVehiculo && 
                      metodoPago && 
                      nombreValido && 
                      telefonoValido && 
                      emailValido &&
                      marcaValida &&
                      modeloValido &&
                      patenteValida &&
                      ubicacionValida && 
                      fechaValida &&
                      tarjetaValida; // Incluir validación de tarjeta
    
    const btnEnviar = document.getElementById('btn-enviar');
    btnEnviar.disabled = !formValido;
    
    // Actualizar estilos de los campos según validación
    updateFieldValidationStyles({
        nombre: nombreValido,
        telefono: telefonoValido,
        email: emailValido,
        marca_vehiculo: marcaValida,
        modelo_vehiculo: modeloValido,
        patente_vehiculo: patenteValida
    });
    
    console.log('📋 Estado del formulario:', {
        tipoServicio: !!tipoServicio,
        tipoVehiculo: !!tipoVehiculo,
        metodoPago: !!metodoPago,
        nombre: nombreValido,
        telefono: telefonoValido,
        email: emailValido,
        marca: marcaValida,
        modelo: modeloValido,
        patente: patenteValida,
        ubicacion: ubicacionValida,
        fecha: fechaValida,
        tarjeta: tarjetaValida,
        valido: formValido
    });
    
    return formValido;
}

// Actualizar estilos de validación de campos
function updateFieldValidationStyles(validations) {
    Object.keys(validations).forEach(fieldName => {
        const field = document.getElementById(fieldName);
        if (field && field.value.trim()) {
            if (validations[fieldName]) {
                field.style.borderColor = '#00D563';
                field.style.boxShadow = '0 0 10px rgba(0, 213, 99, 0.2)';
            } else {
                field.style.borderColor = '#dc3545';
                field.style.boxShadow = '0 0 10px rgba(220, 53, 69, 0.2)';
            }
        } else {
            // Campo vacío
            field.style.borderColor = 'rgba(255, 255, 255, 0.2)';
            field.style.boxShadow = 'none';
        }
    });
}

// Manejar envío del formulario
function handleFormSubmit(e) {
    e.preventDefault();
    console.log('🚀 Enviando solicitud...');
    
    // Validar que todo esté completo
    if (!validateForm()) {
        return;
    }
    
    // 🆕 ENVIAR FORMULARIO TRADICIONALMENTE (SIN AJAX)
    document.getElementById('formulario-servicio').submit();
}

// Mostrar mensaje de éxito
function showSuccessMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'alert alert-success';
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, rgba(0, 213, 99, 0.9) 0%, rgba(0, 255, 117, 0.8) 100%);
        color: white;
        padding: 1rem 2rem;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 213, 99, 0.3);
        z-index: 9999;
        font-weight: 600;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    `;
    messageDiv.innerHTML = `✅ ${message}`;
    
    document.body.appendChild(messageDiv);
    
    // Remover mensaje después de 5 segundos
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 5000);
}

// Mostrar mensaje de error
function showErrorMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'alert alert-error';
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.9) 0%, rgba(255, 107, 107, 0.8) 100%);
        color: white;
        padding: 1rem 2rem;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(220, 53, 69, 0.3);
        z-index: 9999;
        font-weight: 600;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    `;
    messageDiv.innerHTML = `❌ ${message}`;
    
    document.body.appendChild(messageDiv);
    
    // Remover mensaje después de 5 segundos
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 5000);
}

// Reset completo del formulario
function resetForm() {
    console.log('🔄 Reseteando formulario completo...');
    
    // Reset del mapa
    resetMap();
    
    // Reset de selecciones
    document.querySelectorAll('.service-btn, .option-card').forEach(el => {
        el.classList.remove('active', 'selected');
    });
    
    // Reset de radio buttons
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.checked = false;
    });
    
    // Reset de campos del formulario
    document.getElementById('formulario-servicio').reset();
    
    // Reset de campos ocultos
    document.querySelectorAll('input[type="hidden"]').forEach(input => {
        if (input.name !== 'csrfmiddlewaretoken') {
            input.value = '';
        }
    });
    
    // Ocultar sección de fecha programada
    document.getElementById('fecha-programada').style.display = 'none';
    document.getElementById('fecha_hora').required = false;
    
    // Reset estilos de validación
    document.querySelectorAll('input, textarea, select').forEach(field => {
        field.style.borderColor = 'rgba(255, 255, 255, 0.2)';
        field.style.boxShadow = 'none';
    });
    
    validateForm();
}

// Funciones de utilidad para debugging
function debugFormData() {
    console.log('🔍 Estado actual del formulario:');
    console.log('Tipo servicio:', document.getElementById('hidden_tipo_servicio').value);
    console.log('Tipo vehículo:', document.getElementById('hidden_tipo_vehiculo').value);
    console.log('Método pago:', document.getElementById('hidden_metodo_pago').value);
    console.log('Nombre:', document.getElementById('nombre').value);
    console.log('Teléfono:', document.getElementById('telefono').value);
    console.log('Email:', document.getElementById('email').value);
    console.log('Origen:', document.getElementById('hidden_origen_direccion').value);
    console.log('Destino:', document.getElementById('hidden_destino_direccion').value);
    console.log('Distancia:', document.getElementById('hidden_distancia').value);
    console.log('Precio:', document.getElementById('hidden_precio_total').value);
}

// Función para debuggear específicamente la tarjeta
function debugCreditCard() {
    console.log('🔍 Debug específico de tarjeta:');
    
    const metodoPago = document.getElementById('hidden_metodo_pago').value;
    console.log('Método de pago seleccionado:', metodoPago);
    
    const pasarelaPago = document.getElementById('pasarela-pago');
    console.log('Elemento pasarela encontrado:', !!pasarelaPago);
    
    if (pasarelaPago) {
        console.log('Estado display de pasarela:', pasarelaPago.style.display);
        console.log('Pasarela visible:', pasarelaPago.style.display !== 'none');
    }
    
    if (metodoPago === 'tarjeta') {
        const numeroTarjeta = document.getElementById('numero_tarjeta')?.value || '';
        const fechaVencimiento = document.getElementById('fecha_vencimiento')?.value || '';
        const cvv = document.getElementById('cvv')?.value || '';
        const nombreTitular = document.getElementById('nombre_titular')?.value || '';
        
        console.log('📋 Valores de los campos:');
        console.log('- Número tarjeta:', `"${numeroTarjeta}" (length: ${numeroTarjeta.length})`);
        console.log('- Fecha vencimiento:', `"${fechaVencimiento}" (length: ${fechaVencimiento.length})`);
        console.log('- CVV:', `"${cvv}" (length: ${cvv.length})`);
        console.log('- Nombre titular:', `"${nombreTitular}" (length: ${nombreTitular.length})`);
        
        const numeroLimpio = numeroTarjeta.replace(/\s/g, '');
        console.log('- Número limpio:', `"${numeroLimpio}" (length: ${numeroLimpio.length})`);
        
        console.log('🧪 Validaciones individuales:');
        console.log('- Número >= 13:', numeroLimpio.length >= 13);
        console.log('- Número válido Luhn:', numeroLimpio.length >= 13 ? isValidCreditCard(numeroLimpio) : 'No aplica');
        console.log('- Fecha length === 5:', fechaVencimiento.length === 5);
        console.log('- Fecha válida:', fechaVencimiento.length === 5 ? isValidExpiryDate(fechaVencimiento) : 'No aplica');
        console.log('- CVV >= 3:', cvv.length >= 3);
        console.log('- Titular >= 3:', nombreTitular.trim().length >= 3);
        
    } else {
        console.log('❌ No se seleccionó pago con tarjeta');
    }
    
    // Debug de patente también
    const patente = document.getElementById('patente_vehiculo')?.value || '';
    console.log('🚗 Debug patente:');
    console.log('- Patente actual:', `"${patente}"`);
    console.log('- Es válida:', isValidChileanPlate(patente));
}
function testMetodoPago() {
    console.log('🧪 Valores actuales de método de pago:');
    
    const valoresActuales = [
        'efectivo',      // ✅ Funciona
        'transferencia', // ✅ Funciona  
        'credito',       // 🆕 Tarjeta de crédito
        'debito'         // 🆕 Tarjeta de débito
    ];
    
    console.log('✅ Valores que deberían funcionar:', valoresActuales);
    
    // Mostrar estado actual
    const metodoPagoActual = document.getElementById('hidden_metodo_pago').value;
    console.log('🔍 Método de pago seleccionado actualmente:', metodoPagoActual);
    
    return valoresActuales;
}

// Función para crear página de confirmación temporal
function createConfirmationPage(solicitudData) {
    console.log('📄 Creando página de confirmación temporal...');
    
    // Crear HTML de confirmación
    const confirmationHTML = `
        <div class="container" style="max-width: 800px; margin: 2rem auto; padding: 2rem;">
            <div class="glassmorphism" style="text-align: center;">
                <h1 style="color: #00D563; margin-bottom: 2rem;">
                    ✅ ¡Solicitud Enviada Exitosamente!
                </h1>
                
                <div style="background: rgba(0, 213, 99, 0.1); border: 1px solid rgba(0, 213, 99, 0.3); border-radius: 15px; padding: 2rem; margin: 2rem 0;">
                    <h2 style="color: #00D563; margin-bottom: 1.5rem;">📋 Detalles de tu Solicitud</h2>
                    
                    <div style="text-align: left; display: grid; gap: 1rem;">
                        <div class="detail-item">
                            <strong style="color: #00D563;">🚛 Tipo de Servicio:</strong>
                            <span>${solicitudData.tipoServicio === 'inmediato' ? 'Servicio Inmediato' : 'Servicio Programado'}</span>
                        </div>
                        
                        ${solicitudData.fechaHora ? `
                        <div class="detail-item">
                            <strong style="color: #00D563;">📅 Fecha y Hora:</strong>
                            <span>${new Date(solicitudData.fechaHora).toLocaleString('es-CL')}</span>
                        </div>
                        ` : ''}
                        
                        <div class="detail-item">
                            <strong style="color: #00D563;">🚗 Tipo de Vehículo:</strong>
                            <span>${solicitudData.tipoVehiculo}</span>
                        </div>
                        
                        <div class="detail-item">
                            <strong style="color: #00D563;">🏁 Origen:</strong>
                            <span>${solicitudData.origenDireccion}</span>
                        </div>
                        
                        <div class="detail-item">
                            <strong style="color: #00D563;">🎯 Destino:</strong>
                            <span>${solicitudData.destinoDireccion}</span>
                        </div>
                        
                        <div class="detail-item">
                            <strong style="color: #00D563;">📏 Distancia:</strong>
                            <span>${solicitudData.distancia} km</span>
                        </div>
                        
                        <div class="detail-item">
                            <strong style="color: #00D563;">💰 Precio Total:</strong>
                            <span style="font-size: 1.2rem; font-weight: bold;">${parseInt(solicitudData.precioTotal).toLocaleString('es-CL')}</span>
                        </div>
                        
                        <div class="detail-item">
                            <strong style="color: #00D563;">💳 Método de Pago:</strong>
                            <span>${solicitudData.metodoPago}</span>
                        </div>
                        
                        <div class="detail-item">
                            <strong style="color: #00D563;">👤 Cliente:</strong>
                            <span>${solicitudData.nombre}</span>
                        </div>
                        
                        <div class="detail-item">
                            <strong style="color: #00D563;">📞 Teléfono:</strong>
                            <span>${solicitudData.telefono}</span>
                        </div>
                        
                        ${solicitudData.email ? `
                        <div class="detail-item">
                            <strong style="color: #00D563;">📧 Email:</strong>
                            <span>${solicitudData.email}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div style="margin-top: 2rem;">
                    <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 1rem;">
                        Te contactaremos pronto para coordinar el servicio.
                    </p>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button onclick="window.location.href='/dashboard/'" 
                                style="background: linear-gradient(135deg, #00D563 0%, #00ff75 100%); 
                                       border: none; border-radius: 25px; padding: 0.8rem 2rem; 
                                       color: white; font-weight: 600; cursor: pointer; 
                                       transition: transform 0.3s ease;">
                            🏠 Ir al Dashboard
                        </button>
                        
                        <button onclick="window.location.href='/solicitar-servicio/'" 
                                style="background: rgba(255, 255, 255, 0.1); border: 2px solid #00D563; 
                                       border-radius: 25px; padding: 0.8rem 2rem; color: #00D563; 
                                       font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                            🚛 Nueva Solicitud
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Reemplazar el contenido de la página
    document.body.innerHTML = confirmationHTML;
    
    // Aplicar estilos base
    document.body.style.cssText = `
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
        color: #ffffff;
        min-height: 100vh;
        margin: 0;
        padding: 0;
    `;
}

// Función para detectar la URL correcta de detalles
function detectCorrectDetailUrl(solicitudId) {
    console.log('🔍 Detectando URL correcta para solicitud ID:', solicitudId);
    
    // Lista de posibles formatos de URL
    const possibleUrls = [
        `/solicitud/${solicitudId}/`,
        `/solicitudes/${solicitudId}/detalle/`,
        `/dashboard/solicitud/${solicitudId}/`,
        `/detalle-solicitud/${solicitudId}/`,
        `/solicitud-detalle/${solicitudId}/`,
        `/grua/solicitud/${solicitudId}/`,
        `/servicios/solicitud/${solicitudId}/`
    ];
    
    console.log('🔍 URLs a verificar:', possibleUrls);
    
    // Función para verificar si una URL existe
    async function checkUrlExists(url) {
        try {
            const response = await fetch(url, { method: 'HEAD' });
            return response.ok;
        } catch (error) {
            return false;
        }
    }
    
    // Verificar cada URL y usar la primera que funcione
    return new Promise(async (resolve) => {
        for (const url of possibleUrls) {
            console.log('🔍 Verificando URL:', url);
            const exists = await checkUrlExists(url);
            if (exists) {
                console.log('✅ URL encontrada:', url);
                resolve(url);
                return;
            }
        }
        
        // Si ninguna URL funciona, usar la página de confirmación
        console.log('❌ Ninguna URL de detalle funciona, usando página de confirmación');
        resolve(null);
    });
}

// Función mejorada para redirigir con detección automática
async function redirectToSolicitudDetail(solicitudId, solicitudData) {
    console.log('🚀 Iniciando redirección inteligente...');
    
    // Primero intentar detectar la URL correcta
    const correctUrl = await detectCorrectDetailUrl(solicitudId);
    
    if (correctUrl) {
        console.log('🎯 Redirigiendo a URL detectada:', correctUrl);
        window.location.href = correctUrl;
    } else {
        console.log('📄 Mostrando página de confirmación como fallback');
        createConfirmationPage(solicitudData);
    }
}
function getSolicitudData() {
    return {
        tipoServicio: document.getElementById('hidden_tipo_servicio').value,
        fechaHora: document.getElementById('hidden_fecha_hora').value,
        tipoVehiculo: document.getElementById('hidden_tipo_vehiculo').value,
        metodoPago: document.getElementById('hidden_metodo_pago').value,
        origenDireccion: document.getElementById('hidden_origen_direccion').value,
        destinoDireccion: document.getElementById('hidden_destino_direccion').value,
        distancia: document.getElementById('hidden_distancia').value,
        precioTotal: document.getElementById('hidden_precio_total').value,
        nombre: document.getElementById('nombre').value,
        telefono: document.getElementById('telefono').value,
        email: document.getElementById('email').value
    };
}
window.debugGrua = {
    resetForm: resetForm,
    debugFormData: debugFormData,
    testMetodoPago: testMetodoPago,
    validateForm: validateForm,
    updatePrice: updatePrice,
    resetMap: resetMap
};

console.log('✅ Script cargado completamente');
console.log('🛠️ Debug disponible: window.debugGrua');
console.log('🧪 Para ver valores de método de pago: window.debugGrua.testMetodoPago()');
</script>
{% endblock %}